{% raw %}{% extends "base.html" %}

{% block title %}‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢{% endblock %}

{% block head_extra %}
<style>
    /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
    .fc-header-toolbar {
        flex-wrap: wrap;
        font-size: 0.8rem;
    }
    .fc-event-main {
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
        <h1 class="h2 mb-0">üóìÔ∏è ‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</h1>
        <div class="form-check form-switch my-2">
            <input class="form-check-input" type="checkbox" role="switch" id="showCompletedToggle">
            <label class="form-check-label" for="showCompletedToggle">‡∏ã‡πà‡∏≠‡∏ô‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</label>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-9">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div id="calendar" style="min-height: 600px;"></div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 mt-3 mt-lg-0">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</h5>
                </div>
                <div id="unscheduled-tasks" class="list-group list-group-flush" style="max-height: 600px; overflow-y: auto;">
                    {% for task in unscheduled_tasks %}
                    <a href="{{ url_for('liff.job_details', customer_id=task.customer.id, job_id=task.id) }}" class="fc-event list-group-item list-group-item-action" data-event-id="{{ task.id }}">
                        <strong>#{{ task.id }} {{ task.customer.name }}</strong>
                        <div class="small text-muted">{{ task.job_title }}</div>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block body_extra %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    const showCompletedToggle = document.getElementById('showCompletedToggle');
    let allApiEvents = []; // Cache for all events from the API

    const calendar = new FullCalendar.Calendar(calendarEl, {
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,listWeek'
        },
        initialView: 'dayGridMonth',
        locale: 'th',
        events: function(fetchInfo, successCallback, failureCallback) {
            fetch('{{ url_for("api_calendar_tasks") }}')
                .then(response => response.json())
                .then(data => {
                    allApiEvents = data;
                    let filteredEvents = showCompletedToggle.checked
                        ? allApiEvents.filter(event => !event.extendedProps.is_completed)
                        : allApiEvents;
                    successCallback(filteredEvents);
                })
                .catch(error => {
                    console.error("Error fetching calendar events:", error);
                    failureCallback(error);
                });
        },
        editable: true,
        droppable: true,

        // Function to style completed events
        eventDidMount: function(info) {
            if (info.event.extendedProps.is_completed) {
                info.el.style.backgroundColor = '#e9ecef';
                info.el.style.borderColor = '#ced4da';
                const titleEl = info.el.querySelector('.fc-event-title');
                if (titleEl) {
                    titleEl.style.color = '#6c757d';
                    titleEl.style.textDecoration = 'line-through';
                }
            }
        },

        // Handler for clicking an event
        eventClick: function(info) {
            info.jsEvent.preventDefault(); // don't let the browser navigate
            if (info.event.url) {
                window.open(info.event.url, "_self");
            }
        },

        // Handler for dragging and dropping an event
        eventDrop: function(info) {
            const eventData = {
                job_id: info.event.id,
                new_due_date: info.event.start.toISOString()
            };
            fetch('/api/task/schedule_from_calendar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify(eventData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status !== 'success') {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + data.message);
                    info.revert();
                }
            }).catch(() => {
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ');
                info.revert();
            });
        },
        
        // Handler for dropping an external event from the list
        drop: function(info) {
             const eventId = info.draggedEl.dataset.eventId;
             if (!eventId) return;

             const eventData = {
                job_id: eventId,
                new_due_date: info.date.toISOString()
             };
             fetch('/api/task/schedule_from_calendar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify(eventData)
             })
             .then(res => res.json())
             .then(data => {
                 if (data.status === 'success') {
                     info.draggedEl.remove(); // Remove from the list
                     calendar.refetchEvents(); // Refresh calendar to show the new event
                 } else {
                     alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + data.message);
                 }
             }).catch(() => alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ'));
        }
    });

    calendar.render();

    // Event listener for the toggle switch
    showCompletedToggle.addEventListener('change', function() {
        calendar.refetchEvents(); // This will re-run the `events` function which applies the filter
    });

    // Make unscheduled tasks draggable
    new FullCalendar.Draggable(document.getElementById('unscheduled-tasks'), {
        itemSelector: '.fc-event'
    });
});
</script>
{% endblock %}
{% endraw %}