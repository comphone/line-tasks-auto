<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #f0f2f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            width: 90%;
            max-width: 450px;
            border: none;
            border-radius: 1rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .error-container {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
        }
        .debug-info {
            background-color: #e2e3e5;
            border: 1px solid #d6d8db;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-top: 0.5rem;
            font-size: 0.8rem;
            font-family: monospace;
        }
        .btn-location {
            background: linear-gradient(45deg, #007bff, #0056b3);
            border: none;
            border-radius: 0.75rem;
            padding: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,123,255,0.3);
            transition: all 0.3s ease;
        }
        .btn-location:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,123,255,0.4);
        }
        .success-animation {
            animation: successPulse 0.6s ease-in-out;
        }
        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="card text-center">
        <div class="card-body p-4">
            <!-- Loading State -->
            <div id="loading-state">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô LIFF App...</p>
                <small class="text-muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</small>
            </div>

            <!-- Main Content -->
            <div id="main-content" style="display: none;">
                <img id="user-avatar" src="" class="rounded-circle mb-3" width="80" height="80" alt="User Avatar">
                <h5 class="card-title mb-3">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <span id="user-name"></span>!</h5>
                <p class="card-text text-muted mb-4">
                    ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏á‡∏≤‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á
                </p>
                <button id="update-location-btn" class="btn btn-primary btn-location w-100">
                    <i class="fas fa-map-marker-alt me-2"></i>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô
                </button>
                
                <!-- Debug Info (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î) -->
                <div id="debug-container" style="display: none;">
                    <div class="debug-info">
                        <strong>üîç Debug Information:</strong>
                        <div id="debug-content"></div>
                    </div>
                </div>
            </div>
            
            <!-- Status Messages -->
            <div id="status-message" class="mt-3"></div>
            
            <!-- Error Container -->
            <div id="error-container" class="error-container" style="display: none;">
                <h6 class="text-danger mb-2">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h6>
                <div id="error-message"></div>
                <div id="error-solutions" class="mt-2">
                    <small><strong>üîß ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</strong></small>
                    <ul class="text-start small mt-1 mb-0">
                        <li>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï</li>
                        <li>‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏¥‡∏î LINE App ‡πÉ‡∏´‡∏°‡πà</li>
                        <li>‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ LINE ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</li>
                        <li>‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô 1-2 ‡∏ô‡∏≤‡∏ó‡∏µ</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingState = document.getElementById('loading-state');
            const mainContent = document.getElementById('main-content');
            const statusMessage = document.getElementById('status-message');
            const updateBtn = document.getElementById('update-location-btn');
            const errorContainer = document.getElementById('error-container');
            const errorMessage = document.getElementById('error-message');
            const debugContainer = document.getElementById('debug-container');
            const debugContent = document.getElementById('debug-content');

            function showStatus(message, isError = false, showDebug = false) {
                statusMessage.textContent = message;
                statusMessage.className = isError ? 'alert alert-danger mt-3' : 'alert alert-info mt-3';
                
                if (isError) {
                    loadingState.style.display = 'none';
                    mainContent.style.display = 'none';
                    errorContainer.style.display = 'block';
                    errorMessage.textContent = message;
                    
                    if (showDebug) {
                        debugContainer.style.display = 'block';
                    }
                }
            }

            function addDebugInfo(info) {
                const debugHtml = Object.entries(info).map(([key, value]) => 
                    `<div><strong>${key}:</strong> ${JSON.stringify(value)}</div>`
                ).join('');
                debugContent.innerHTML = debugHtml;
            }

            try {
                // ‚≠ê ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô LIFF Initialization ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß ‚≠ê
                const liffId = "{{ LIFF_ID_TECHNICIAN_LOCATION }}";
                
                console.log("üîç Technician Location LIFF Debug:");
                console.log("- LIFF ID from server:", liffId);
                console.log("- LIFF ID type:", typeof liffId);
                console.log("- LIFF ID length:", liffId ? liffId.length : 0);
                
                // Validation ‡∏Ç‡∏±‡πâ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
                if (!liffId || liffId.trim() === '' || liffId === 'None' || liffId === 'undefined') {
                    const debugInfo = {
                        'LIFF_ID_VALUE': liffId,
                        'LIFF_ID_TYPE': typeof liffId,
                        'LIFF_ID_LENGTH': liffId ? liffId.length : 0,
                        'PAGE_URL': window.location.href,
                        'USER_AGENT': navigator.userAgent.substring(0, 100) + '...'
                    };
                    
                    addDebugInfo(debugInfo);
                    throw new Error(`LIFF ID ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: "${liffId}". ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Environment Variables`);
                }
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö LIFF ID
                const liffIdPattern = /^\d{10}-[a-zA-Z0-9]{8}$/;
                if (!liffIdPattern.test(liffId)) {
                    const debugInfo = {
                        'LIFF_ID_VALUE': liffId,
                        'EXPECTED_PATTERN': 'nnnnnnnnnn-xxxxxxxx',
                        'PATTERN_MATCH': liffIdPattern.test(liffId),
                        'VALIDATION_ERROR': 'Invalid LIFF ID format'
                    };
                    
                    addDebugInfo(debugInfo);
                    throw new Error(`‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö LIFF ID ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: "${liffId}". ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô nnnnnnnnnn-xxxxxxxx`);
                }
                
                console.log("‚úÖ LIFF ID validation passed");
                console.log("üöÄ Initializing LIFF...");
                
                // Initialize LIFF
                await liff.init({ liffId: liffId });
                console.log("‚úÖ Technician Location LIFF initialized successfully");
                // ‚≠ê ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏™‡πà‡∏ß‡∏ô LIFF Initialization ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÅ‡∏•‡πâ‡∏ß ‚≠ê

                if (!liff.isLoggedIn()) {
                    showStatus("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô", true);
                    console.log("‚ùå User not logged in, redirecting...");
                    liff.login();
                    return;
                }

                // 2. Get user profile
                const profile = await liff.getProfile();
                console.log("‚úÖ User profile loaded:", profile.displayName);
                
                document.getElementById('user-avatar').src = profile.pictureUrl || 'https://via.placeholder.com/80/007bff/ffffff?text=üë§';
                document.getElementById('user-name').textContent = profile.displayName || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
                
                loadingState.style.display = 'none';
                mainContent.style.display = 'block';

                // 3. Add event listener to the button
                updateBtn.addEventListener('click', async () => {
                    const originalBtnHtml = updateBtn.innerHTML;
                    showStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...", false);
                    updateBtn.disabled = true;
                    updateBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...`;

                    // 4. Use navigator.geolocation to get location
                    if (!navigator.geolocation) {
                        const debugInfo = {
                            'GEOLOCATION_SUPPORTED': false,
                            'USER_AGENT': navigator.userAgent,
                            'HTTPS_PROTOCOL': window.location.protocol === 'https:'
                        };
                        addDebugInfo(debugInfo);
                        showStatus("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation", true, true);
                        updateBtn.disabled = false;
                        updateBtn.innerHTML = originalBtnHtml;
                        return;
                    }

                    const geolocationOptions = {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 0
                    };

                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            try {
                                const { latitude, longitude, accuracy } = position.coords;
                                console.log(`üìç Location found: ${latitude}, ${longitude} (accuracy: ${accuracy}m)`);
                                
                                showStatus("‡∏û‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå...", false);
                                updateBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...`;

                                // 5. Send data to backend API
                                const response = await fetch('/api/technician-location/update', {
                                    method: 'POST',
                                    headers: { 
                                        'Content-Type': 'application/json',
                                        'X-Requested-With': 'XMLHttpRequest'
                                    },
                                    body: JSON.stringify({
                                        line_user_id: profile.userId,
                                        latitude: latitude,
                                        longitude: longitude,
                                        accuracy: accuracy,
                                        timestamp: new Date().toISOString()
                                    })
                                });

                                if (!response.ok) {
                                    const errorText = await response.text();
                                    throw new Error(`Server Error (${response.status}): ${errorText}`);
                                }

                                const result = await response.json();
                                if (result.status !== 'success') {
                                    throw new Error(result.message || 'Unknown server error');
                                }

                                // Success!
                                console.log("‚úÖ Location updated successfully");
                                mainContent.classList.add('success-animation');
                                updateBtn.className = 'btn btn-success btn-location w-100';
                                updateBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
                                
                                showStatus("üéâ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÅ‡∏≠‡∏õ‡∏à‡∏∞‡∏õ‡∏¥‡∏î‡πÉ‡∏ô 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ", false);
                                
                                setTimeout(() => {
                                    if (liff.isInClient()) {
                                        liff.closeWindow();
                                    } else {
                                        window.close();
                                    }
                                }, 3000);

                            } catch (apiError) {
                                console.error("‚ùå API Error:", apiError);
                                const debugInfo = {
                                    'API_ERROR': apiError.message,
                                    'LOCATION_DATA': {
                                        latitude: position.coords.latitude,
                                        longitude: position.coords.longitude,
                                        accuracy: position.coords.accuracy
                                    },
                                    'USER_ID': profile.userId,
                                    'TIMESTAMP': new Date().toISOString()
                                };
                                addDebugInfo(debugInfo);
                                showStatus(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${apiError.message}`, true, true);
                                updateBtn.disabled = false;
                                updateBtn.innerHTML = originalBtnHtml;
                            }
                        },
                        (geoError) => {
                            console.error("‚ùå Geolocation Error:", geoError);
                            
                            let errorMessage = `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ`;
                            let solutions = [];
                            
                            switch(geoError.code) {
                                case 1: // PERMISSION_DENIED
                                    errorMessage = "‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò";
                                    solutions = [
                                        "‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ LINE ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå",
                                        "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Privacy ‡∏Ç‡∏≠‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå",
                                        "‡∏•‡∏≠‡∏á‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î LINE App ‡πÉ‡∏´‡∏°‡πà"
                                    ];
                                    break;
                                case 2: // POSITION_UNAVAILABLE
                                    errorMessage = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ";
                                    solutions = [
                                        "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ GPS",
                                        "‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏•‡πà‡∏á‡πÅ‡∏™‡∏á",
                                        "‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà"
                                    ];
                                    break;
                                case 3: // TIMEOUT
                                    errorMessage = "‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á";
                                    solutions = [
                                        "‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á",
                                        "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì GPS",
                                        "‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏î‡∏µ"
                                    ];
                                    break;
                            }
                            
                            const debugInfo = {
                                'GEOLOCATION_ERROR_CODE': geoError.code,
                                'GEOLOCATION_ERROR_MESSAGE': geoError.message,
                                'GEOLOCATION_OPTIONS': geolocationOptions,
                                'BROWSER_INFO': {
                                    userAgent: navigator.userAgent.substring(0, 100),
                                    language: navigator.language,
                                    platform: navigator.platform
                                }
                            };
                            
                            addDebugInfo(debugInfo);
                            
                            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï error solutions
                            const errorSolutions = document.getElementById('error-solutions');
                            if (errorSolutions && solutions.length > 0) {
                                errorSolutions.innerHTML = `
                                    <small><strong>üîß ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏â‡∏û‡∏≤‡∏∞:</strong></small>
                                    <ul class="text-start small mt-1 mb-0">
                                        ${solutions.map(solution => `<li>${solution}</li>`).join('')}
                                    </ul>
                                `;
                            }
                            
                            showStatus(errorMessage, true, true);
                            updateBtn.disabled = false;
                            updateBtn.innerHTML = originalBtnHtml;
                        },
                        geolocationOptions
                    );
                });

            } catch (err) {
                console.error("‚ùå LIFF Error:", err);
                
                const debugInfo = {
                    'ERROR_MESSAGE': err.message,
                    'ERROR_STACK': err.stack ? err.stack.substring(0, 500) : 'No stack trace',
                    'LIFF_ID_ATTEMPTED': "{{ LIFF_ID_TECHNICIAN_LOCATION }}",
                    'PAGE_URL': window.location.href,
                    'TIMESTAMP': new Date().toISOString(),
                    'USER_AGENT': navigator.userAgent.substring(0, 100) + '...'
                };
                
                addDebugInfo(debugInfo);
                showStatus(`LIFF Error: ${err.message}`, true, true);
            }
        });
    </script>
</body>
</html>