{% extends "base.html" %}

{% block title %}
    {% if report_type == 'completion' %}
        สรุปการปฏิบัติงาน
    {% elif report_type == 'reschedule' %}
        สรุปเหตุผลการเลื่อนนัด
    {% else %}
        รายงานความคืบหน้า
    {% endif %}
{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">
                {% if report_type == 'completion' %}
                    <i class="fas fa-check-circle me-2"></i>สรุปการปฏิบัติงาน
                {% elif report_type == 'reschedule' %}
                    <i class="fas fa-calendar-alt me-2"></i>สรุปเหตุผลการเลื่อนนัด
                {% else %}
                    <i class="fas fa-tools me-2"></i>รายงานความคืบหน้า
                {% endif %}
            </h4>
        </div>
        <div class="card-body">
            <form id="report-form" action="{{ url_for('liff.submit_technician_report') }}" method="post" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="report_type" value="{{ report_type }}">
                <input type="hidden" name="customer_id" value="{{ customer_info.id }}">
                <input type="hidden" name="job_id" value="{{ job_id }}">
                <input type="hidden" name="technician_line_user_id" id="technician_line_user_id">

                <div class="mb-3">
                    <label for="task-selection" class="form-label">ชื่องาน:</label>
                    <select class="form-select" id="task-selection" name="task_id" required>
                        <option value="">-- กรุณาเลือกงาน --</option>
                        {% for task in tasks %}
                            <option value="{{ task['id'] }}" {% if task['id'] == job_id %}selected{% endif %} data-customer-id="{{ task['customer_id'] }}">
                                {{ task['title'] }} (ลูกค้า: {{ task['customer_name'] }})
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div id="customer-info-display" class="card bg-light p-3 mb-3" style="display: none;">
                    <h5>ข้อมูลลูกค้า</h5>
                    <p class="mb-1"><strong>ชื่อ:</strong> <span id="customer-name"></span></p>
                    <p class="mb-1"><strong>โทร:</strong> <a href="#" id="customer-phone"></a></p>
                    <p class="mb-0"><strong>ที่อยู่:</strong> <span id="customer-address"></span></p>
                    <a href="#" id="customer-map-link" class="btn btn-sm btn-outline-primary mt-2" target="_blank" style="display: none;"><i class="fas fa-map-marker-alt me-2"></i>ดูแผนที่</a>
                </div>

                <div class="mb-3">
                    <label for="work-summary" class="form-label">
                        {% if report_type == 'reschedule' %}
                            สรุปเหตุผลที่ต้องเลื่อนนัด
                        {% else %}
                            สรุปการปฏิบัติงาน / ความคืบหน้า
                        {% endif %}
                    </label>
                    <textarea class="form-control" id="work-summary" name="work_summary" rows="5" required></textarea>
                </div>

                {% if report_type == 'reschedule' %}
                <div class="mb-3">
                    <label for="new-due-date" class="form-label">นัดหมายครั้งถัดไป</label>
                    <input type="datetime-local" class="form-control" id="new-due-date" name="new_due_date">
                </div>
                {% endif %}

                <div class="mb-3">
                    <label class="form-label">ช่างผู้ปฏิบัติงาน (เลือกได้มากกว่า 1 คน)</label>
                    <div id="technician-checkboxes">
                        {% for tech in technician_list %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="technicians" value="{{ tech.name }}" id="tech-{{ loop.index }}">
                            <label class="form-check-label" for="tech-{{ loop.index }}">
                                {{ tech.name }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="mb-3">
                    <label for="attachments" class="form-label">แนบไฟล์รูปภาพ/เอกสาร</label>
                    <button type="button" class="btn btn-secondary" id="open-attachment-modal"><i class="fas fa-paperclip me-2"></i>เพิ่มไฟล์แนบ</button>
                    <div id="attachment-previews" class="mt-2"></div>
                </div>

                <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lg" id="submit-report-btn">
                        <i class="fas fa-paper-plane me-2"></i>ส่งรายงาน
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% include 'modals/attachment_uploader.html' %}
{% endblock %}

{% block scripts %}
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const liffId = "{{ liff_id }}";
    let liffProfile = null;

    function initializeLiff() {
        liff.init({ liffId: liffId })
            .then(() => {
                if (liff.isLoggedIn()) {
                    liff.getProfile()
                        .then(profile => {
                            liffProfile = profile;
                            document.getElementById('technician_line_user_id').value = profile.userId;
                            preselectTechnician(profile.userId);
                        })
                        .catch(err => console.error('LIFF getProfile failed', err));
                } else {
                    liff.login();
                }
            })
            .catch(err => console.error('LIFF Initialization failed', err));
    }

    function preselectTechnician(userId) {
        const technicianList = {{ technician_list|tojson }};
        const loggedInTechnician = technicianList.find(tech => tech.line_user_id === userId);
        if (loggedInTechnician) {
            const checkbox = document.querySelector(`input[name="technicians"][value="${loggedInTechnician.name}"]`);
            if (checkbox) {
                checkbox.checked = true;
            }
        }
    }
    
    initializeLiff();

    const taskSelect = document.getElementById('task-selection');
    const customerInfoDiv = document.getElementById('customer-info-display');
    const allTasks = {{ tasks|tojson }};

    function updateCustomerInfo(selectedJobId) {
        if (!selectedJobId) {
            customerInfoDiv.style.display = 'none';
            return;
        }

        const selectedTask = allTasks.find(task => task.id == selectedJobId);
        if (selectedTask) {
            document.getElementById('customer-name').textContent = selectedTask.customer_name || '-';
            const phoneLink = document.getElementById('customer-phone');
            phoneLink.textContent = selectedTask.customer_phone || '-';
            phoneLink.href = selectedTask.customer_phone ? `tel:${selectedTask.customer_phone}` : '#';
            document.getElementById('customer-address').textContent = selectedTask.customer_address || '-';
            const mapLink = document.getElementById('customer-map-link');
            if(selectedTask.customer_map_url) {
                mapLink.href = selectedTask.customer_map_url;
                mapLink.style.display = 'inline-block';
            } else {
                mapLink.style.display = 'none';
            }
            customerInfoDiv.style.display = 'block';
        } else {
             customerInfoDiv.style.display = 'none';
        }
    }

    taskSelect.addEventListener('change', function() {
        updateCustomerInfo(this.value);
    });

    // Initial load
    if(taskSelect.value) {
        updateCustomerInfo(taskSelect.value);
    }
    
    // Attachment handling logic from attachment_uploader.html
    const attachmentModal = new bootstrap.Modal(document.getElementById('attachmentUploaderModal'));
    document.getElementById('open-attachment-modal').addEventListener('click', () => attachmentModal.show());
    
    const uploader = document.getElementById('attachment-uploader');
    const fileInput = document.getElementById('file-input');
    const previewsContainer = document.getElementById('attachment-previews');

    uploader.addEventListener('click', () => fileInput.click());
    uploader.addEventListener('dragover', (e) => { e.preventDefault(); uploader.classList.add('border-primary'); });
    uploader.addEventListener('dragleave', () => uploader.classList.remove('border-primary'));
    uploader.addEventListener('drop', (e) => {
        e.preventDefault();
        uploader.classList.remove('border-primary');
        handleFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener('change', () => handleFiles(fileInput.files));

    let uploadedFiles = [];

    function handleFiles(files) {
        for (const file of files) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const previewId = `preview-${Date.now()}`;
                const previewHtml = `
                    <div class="attachment-preview-item" id="${previewId}">
                        <div class="progress mb-2" style="height: 5px;">
                          <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-file-alt fa-2x me-2 text-secondary"></i>
                            <span class="file-name">${file.name}</span>
                            <button type="button" class="btn-close ms-auto" aria-label="Close"></button>
                        </div>
                    </div>`;
                previewsContainer.insertAdjacentHTML('beforeend', previewHtml);
                uploadFile(file, previewId);
            };
            reader.readAsDataURL(file);
        }
        attachmentModal.hide();
    }

    function uploadFile(file, previewId) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('job_id', taskSelect.value);
        
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '{{ url_for("api_upload_attachment") }}', true);
        xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token() }}');

        const progressBar = document.querySelector(`#${previewId} .progress-bar`);

        xhr.upload.onprogress = function(event) {
            if (event.lengthComputable) {
                const percentComplete = (event.loaded / event.total) * 100;
                progressBar.style.width = percentComplete + '%';
                progressBar.setAttribute('aria-valuenow', percentComplete);
            }
        };

        xhr.onload = function() {
            if (xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);
                if (response.status === 'success') {
                    const hiddenInput = `<input type="hidden" name="attachment_ids[]" value="${response.file_info.id}">`;
                    document.getElementById('report-form').insertAdjacentHTML('beforeend', hiddenInput);
                    progressBar.classList.add('bg-success');

                    // Set up remove button
                    const previewItem = document.getElementById(previewId);
                    previewItem.querySelector('.btn-close').addEventListener('click', () => {
                         previewItem.remove();
                         // We don't delete from Drive here, just remove from form
                         // The file will be an orphan but can be cleaned up later if needed.
                    });

                } else {
                    progressBar.classList.add('bg-danger');
                    document.querySelector(`#${previewId} .file-name`).textContent += ` - ${response.message}`;
                }
            } else {
                 progressBar.classList.add('bg-danger');
                 document.querySelector(`#${previewId} .file-name`).textContent += ` - Upload failed`;
            }
        };

        xhr.onerror = function() {
            progressBar.classList.add('bg-danger');
            document.querySelector(`#${previewId} .file-name`).textContent += ` - Network error`;
        };

        xhr.send(formData);
    }

    document.getElementById('report-form').addEventListener('submit', function() {
        document.getElementById('submit-report-btn').disabled = true;
        document.getElementById('submit-report-btn').innerHTML = `
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            กำลังส่ง...
        `;
    });
});
</script>
{% endblock %}