{% extends "base.html" %}

{% block title %}‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö{% endblock %}

{% block head_extra %}
<style>
    .technician-management-list .list-group-item {
        display: flex;
        align-items: center;
    }
    .technician-management-list .technician-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 1rem;
        background-color: #e9ecef;
    }
    .technician-management-list .technician-name {
        flex-grow: 1;
        font-weight: 500;
    }
    .template-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        border-radius: 0.375rem;
        background-color: #f8f9fa;
    }
    .template-item input {
        border: none;
        background-color: transparent;
    }
    .template-item input:focus {
        box-shadow: none;
        background-color: #fff;
    }
    /* ... (‡πÇ‡∏Ñ‡πâ‡∏î style ‡πÄ‡∏î‡∏¥‡∏°) ... */
    /* --- START: ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Multi-select --- */
    #warehouse-tech-name { height: 150px; }
    /* --- END: ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Multi-select --- */	
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2 mb-0">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h1>
    <a href="{{ url_for('logout') }}" class="btn btn-outline-danger"><i class="fas fa-sign-out-alt me-2"></i>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</a>
</div>

<div id="flash-messages-area">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message | safe }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}
</div>

<div class="card shadow-sm mb-4">
    <div class="card-header bg-dark text-white">
        <h5 class="mb-0"><i class="fas fa-users-cog me-2"></i>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</h5>
    </div>
    <div class="card-body p-4">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th>
                        <th>‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</th>
                        <th class="text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody id="user-list-body">
                    </tbody>
            </table>
        </div>
        <button class="btn btn-success" id="add-user-btn">
            <i class="fas fa-plus me-2"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà
        </button>
    </div>
</div>

<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalLabel">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="user-id">
                <div class="mb-3">
                    <label for="user-username" class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="user-username" required>
                </div>
                <div class="mb-3">
                    <label for="user-password" class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô <span id="password-required-star" class="text-danger">*</span></label>
                    <input type="password" class="form-control" id="user-password">
                    <small id="password-help" class="form-text text-muted">‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</small>
                </div>
                <div class="mb-3">
                    <label for="user-role" class="form-label">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</label>
                    <select class="form-select" id="user-role">
                        <option value="user">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (User)</option>
                        <option value="admin">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="button" class="btn btn-primary" id="save-user-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>
</div>
<div class="card shadow-sm mb-4">
    <div class="card-header bg-dark text-white">
        <h5 class="mb-0"><i class="fas fa-warehouse me-2"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h5>
    </div>
    <div class="card-body p-4">
        <p class="text-muted">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏•‡∏±‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏±‡∏á‡∏¢‡πà‡∏≠‡∏¢‡∏ö‡∏ô‡∏£‡∏ñ‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô</p>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏±‡∏á</th>
                        <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                        <th>‡∏ä‡πà‡∏≤‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</th>
                        <th class="text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody id="warehouse-list-body">
                    {% for wh in warehouses %}
                    <tr data-id="{{ wh.id }}" data-name="{{ wh.name }}" data-type="{{ wh.type }}" data-tech="{{ wh.technician_name or '' }}">
                        <td>{{ wh.name }}</td>
                        <td><span class="badge bg-secondary">{{ '‡∏Ñ‡∏•‡∏±‡∏á‡∏´‡∏•‡∏±‡∏Å' if wh.type == 'main' else '‡∏£‡∏ñ‡∏ä‡πà‡∏≤‡∏á' }}</span></td>
                        <td>{{ wh.technician_name or '-' }}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-primary edit-warehouse-btn"><i class="fas fa-pen"></i></button>
                            <button class="btn btn-sm btn-outline-danger delete-warehouse-btn"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <button class="btn btn-success" id="add-warehouse-btn"><i class="fas fa-plus me-2"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏±‡∏á‡πÉ‡∏´‡∏°‡πà</button>
    </div>
</div>
<div class="modal fade" id="warehouseModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="warehouseModalLabel">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="warehouse-id">
                <div class="mb-3">
                    <label for="warehouse-name" class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏±‡∏á <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="warehouse-name" required>
                </div>
                <div class="mb-3">
                    <label for="warehouse-type" class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏•‡∏±‡∏á</label>
                    <select class="form-select" id="warehouse-type">
                        <option value="main">‡∏Ñ‡∏•‡∏±‡∏á‡∏´‡∏•‡∏±‡∏Å</option>
                        <option value="technician_van">‡∏Ñ‡∏•‡∏±‡∏á‡∏£‡∏ñ‡∏ä‡πà‡∏≤‡∏á</option>
                    </select>
                </div>
				<div class="mb-3" id="technician-name-group" style="display: none;">
					<label for="warehouse-tech-name" class="form-label">‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö‡∏ä‡πà‡∏≤‡∏á (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô)</label>
					<select class="form-select" id="warehouse-tech-name" multiple>
						{% for tech in settings.get('technician_list', []) %}
							<option value="{{ tech.name }}">{{ tech.name }}</option>
						{% endfor %}
					</select>
					<small class="form-text text-muted">‡∏Å‡∏î Ctrl (‡∏´‡∏£‡∏∑‡∏≠ Cmd ‡∏ö‡∏ô Mac) ‡∏Ñ‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô</small>
				</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="button" class="btn btn-primary" id="save-warehouse-btn">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>
</div>
<form method="POST" action="{{ url_for('settings_page') }}" id="form_technician_templates">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-comment-dots me-2"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πà‡∏ß‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≤‡∏á)</h5>
        </div>
        <div class="card-body p-4">
            <p class="text-muted">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏≤‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå `/` ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô</p>

            <div class="mb-4">
                <h6 class="mb-2">‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô"</h6>
                <div id="task-details-templates-container" class="d-grid gap-2">
                    </div>
                <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addTemplate('task_details')">
                    <i class="fas fa-plus me-1"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï
                </button>
            </div>
            <hr>
            <div class="mb-4">
                <h6 class="mb-2">‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤ / ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô"</h6>
                <div id="progress-reports-templates-container" class="d-grid gap-2">
                    </div>
                <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addTemplate('progress_reports')">
                    <i class="fas fa-plus me-1"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï
                </button>
            </div>
        </div>
        <div class="card-footer text-end">
            <button type="submit" class="btn btn-info">
                <i class="fas fa-save me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≤‡∏á
            </button>
        </div>
    </div>
</form>

<form method="POST" action="{{ url_for('settings_page') }}" id="form_report_settings">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-bell me-2"></i>‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</h5>
        </div>
        <div class="card-body p-4">
            <div class="row mb-3">
                <label for="appointment_reminder_hour" class="col-md-4 col-form-label">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢ (‡πÇ‡∏°‡∏á‡πÑ‡∏ó‡∏¢)</label>
                <div class="col-md-8">
                    <input type="number" class="form-control" id="appointment_reminder_hour" name="report_times[appointment_reminder_hour_thai]"
                           value="{{ settings.report_times.appointment_reminder_hour_thai }}" min="0" max="23" required>
                </div>
            </div>
            <div class="row mb-3">
                <label for="outstanding_report_hour" class="col-md-4 col-form-label">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡∏á‡∏≤‡∏ô (‡πÇ‡∏°‡∏á‡πÑ‡∏ó‡∏¢)</label>
                <div class="col-md-8">
                    <input type="number" class="form-control" id="outstanding_report_hour" name="report_times[outstanding_report_hour_thai]"
                           value="{{ settings.report_times.outstanding_report_hour_thai }}" min="0" max="23" required>
                </div>
            </div>
            <div class="row mb-3">
                <label for="customer_followup_hour" class="col-md-4 col-form-label">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÇ‡∏°‡∏á‡πÑ‡∏ó‡∏¢)</label>
                <div class="col-md-8">
                    <input type="number" class="form-control" id="customer_followup_hour" name="report_times[customer_followup_hour_thai]"
                           value="{{ settings.report_times.customer_followup_hour_thai }}" min="0" max="23" required>
                </div>
            </div>
        </div>
        <div class="card-footer text-end">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            </button>
        </div>
    </div>
</form>

<form method="POST" action="{{ url_for('settings_page') }}" id="form_message_templates">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-comment-alt me-2"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (Message Templates)</h5>
        </div>
        <div class="card-body p-4">
            <div class="mb-3">
                <label for="template_welcome_customer" class="form-label">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å):</label>
                <textarea class="form-control" id="template_welcome_customer" name="message_templates[welcome_customer]" rows="4">{{ settings.message_templates.welcome_customer }}</textarea>
                <small class="form-text text-muted">‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ: [customer_name], [shop_phone], [shop_line_id]</small>
            </div>
            <hr>
            <div class="mb-3">
                <label for="template_problem_report_admin" class="form-label">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤):</label>
                <textarea class="form-control" id="template_problem_report_admin" name="message_templates[problem_report_admin]" rows="4">{{ settings.message_templates.problem_report_admin }}</textarea>
                <small class="form-text text-muted">‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ: [task_title], [customer_name], [problem_desc], [task_url]</small>
            </div>
            <hr>
            <div class="mb-3">
                <label for="template_daily_reminder_header" class="form-label">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡∏™‡πà‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡πÄ‡∏ä‡πâ‡∏≤):</label>
                <input type="text" class="form-control" id="template_daily_reminder_header" name="message_templates[daily_reminder_header]" value="{{ settings.message_templates.daily_reminder_header }}">
                <small class="form-text text-muted">‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ: [task_count]</small>
            </div>
            <div class="mb-3">
                <label for="template_daily_reminder_task_line" class="form-label">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏á‡∏≤‡∏ô):</label>
                <textarea class="form-control" id="template_daily_reminder_task_line" name="message_templates[daily_reminder_task_line]" rows="5">{{ settings.message_templates.daily_reminder_task_line }}</textarea>
                <small class="form-text text-muted">‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ: [task_title], [customer_name], [customer_phone], [due_date], [map_url], [task_url]</small>
            </div>
        </div>
        <div class="card-footer text-end">
            <button type="submit" class="btn btn-success">
                <i class="fas fa-save me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
            </button>
        </div>
    </div>
</form>

<form method="POST" action="{{ url_for('settings_page') }}" id="form_liff_notifications">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-info text-dark">
            <h5 class="mb-0"><i class="fas fa-mobile-alt me-2"></i>‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (LINE LIFF Popup)</h5>
        </div>
        <div class="card-body p-4">
            <div class="mb-3">
                <label for="liff_popup_base_url" class="form-label">LIFF App Base URL (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏õ):</label>
                <input type="url" class="form-control" id="liff_popup_base_url" name="popup_notifications[liff_popup_base_url]"
                       value="{{ settings.popup_notifications.liff_popup_base_url }}" placeholder="‡πÄ‡∏ä‡πà‡∏ô https://liff.line.me/xxxx-yyyy">
                <div class="form-text">URL ‡∏Ç‡∏≠‡∏á LIFF App ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ô LINE Developers Console (‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Endpoint URL ‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏ß‡πâ)</div>
            </div>
            <hr>
            <h6>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡∏™‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô LINE Push Message ‡πÄ‡∏õ‡∏¥‡∏î LIFF)</h6>

            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="enabled_arrival" name="popup_notifications[enabled_arrival]"
                       {{ 'checked' if settings.popup_notifications.enabled_arrival else '' }}>
                <label class="form-check-label" for="enabled_arrival">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ä‡πà‡∏≤‡∏á‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏ñ‡∏∂‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
            </div>
            <div class="mb-3">
                <label for="message_arrival_template" class="form-label">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö (‡∏ä‡πà‡∏≤‡∏á‡∏à‡∏∞‡∏ñ‡∏∂‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤):</label>
                <textarea class="form-control" id="message_arrival_template" name="popup_notifications[message_arrival_template]">{{ settings.popup_notifications.message_arrival_template }}</textarea>
                <small class="form-text text-muted">‡πÉ‡∏ä‡πâ [technician_name], [customer_name] ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£</small>
            </div>

            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="enabled_completion_customer" name="popup_notifications[enabled_completion_customer]"
                       {{ 'checked' if settings.popup_notifications.enabled_completion_customer else '' }}>
                <label class="form-check-label" for="enabled_completion_customer">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏ñ‡∏∂‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
            </div>
            <div class="mb-3">
                <label for="message_completion_customer_template" class="form-label">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö (‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤):</label>
                <textarea class="form-control" id="message_completion_customer_template" name="popup_notifications[message_completion_customer_template]">{{ settings.popup_notifications.message_completion_customer_template }}</textarea>
                <small class="form-text text-muted">‡πÉ‡∏ä‡πâ [task_title], [customer_name] ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£</small>
            </div>

            <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="enabled_nearby_job" name="popup_notifications[enabled_nearby_job]"
                       {{ 'checked' if settings.popup_notifications.enabled_nearby_job else '' }}>
                <label class="form-check-label" for="enabled_nearby_job">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏á‡∏≤‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≤‡∏á)</label>
            </div>
            <div class="mb-3">
                <label for="nearby_radius_km" class="form-label">‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏á‡∏≤‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á (‡∏Å‡∏°.):</label>
                <input type="number" step="0.1" class="form-control" id="nearby_radius_km" name="popup_notifications[nearby_radius_km]"
                       value="{{ settings.popup_notifications.nearby_radius_km }}">
            </div>
            <div class="mb-3">
                <label for="message_nearby_template" class="form-label">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö (‡∏á‡∏≤‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á):</label>
                <textarea class="form-control" id="message_nearby_template" name="popup_notifications[message_nearby_template]">{{ settings.popup_notifications.message_nearby_template }}</textarea>
                <small class="form-text text-muted">‡πÉ‡∏ä‡πâ [task_title], [distance_km], [customer_name] ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£</small>
            </div>
        </div>
        <div class="card-footer text-end">
            <button type="submit" class="btn btn-info">
                <i class="fas fa-save me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠
            </button>
        </div>
    </div>
</form>

<form method="POST" action="{{ url_for('settings_page') }}" id="form_line_bot_info">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fab fa-line me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• LINE Bot</h5>
        </div>
        <div class="card-body p-4">
            <div class="row mb-3">
                <label for="admin_group_id" class="col-md-4 col-form-label">LINE Admin Group ID</label>
                <div class="col-md-8">
                    <input type="text" class="form-control" id="admin_group_id" name="line_recipients[admin_group_id]"
                           value="{{ settings.line_recipients.admin_group_id }}">
                    <div class="form-text">‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô</div>
                </div>
            </div>
            <div class="row mb-3">
                <label for="technician_group_id" class="col-md-4 col-form-label">LINE Technician Group ID</label>
                <div class="col-md-8">
                    <input type="text" class="form-control" id="technician_group_id" name="line_recipients[technician_group_id]"
                           value="{{ settings.line_recipients.technician_group_id }}">
                    <div class="form-text">‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≤‡∏á (‡∏ñ‡πâ‡∏≤‡πÅ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å Admin)</div>
                </div>
            </div>
             <div class="row mb-3">
                <label for="manager_user_id" class="col-md-4 col-form-label">LINE Manager User ID</label>
                <div class="col-md-8">
                    <input type="text" class="form-control" id="manager_user_id" name="line_recipients[manager_user_id]"
                           value="{{ settings.line_recipients.manager_user_id }}">
                    <div class="form-text">LINE User ID ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</div>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-8 offset-md-4">
                    <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#testNotificationModal">
                        <i class="fas fa-paper-plane me-2"></i>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° LINE
                    </button>
                </div>
            </div>
        </div>
        <div class="card-footer text-end">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• LINE Bot
            </button>
        </div>
    </div>
</form>

<div class="card shadow-sm mb-4">
    <div class="card-header bg-info text-dark">
        <h5 class="mb-0"><i class="fas fa-bug me-2"></i>üîç LIFF Debug Panel</h5>
    </div>
    <div class="card-body p-4">
        <div class="alert alert-info mb-3">
            <strong>üéØ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LIFF Apps:</strong> ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤ LIFF initialization failed
        </div>
        
        <div class="row mb-3">
            <div class="col-md-6 mb-2">
                <button type="button" class="btn btn-info w-100" onclick="checkLiffConfiguration()">
                    <i class="fas fa-search me-2"></i>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö LIFF Configuration
                </button>
            </div>
            <div class="col-md-6 mb-2">
                <button type="button" class="btn btn-warning w-100" onclick="checkEnvironmentVariables()">
                    <i class="fas fa-cog me-2"></i>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Environment Variables
                </button>
            </div>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-6 mb-2">
                <button type="button" class="btn btn-secondary w-100" onclick="testLiffUrls()">
                    <i class="fas fa-link me-2"></i>‡∏ó‡∏î‡∏™‡∏≠‡∏ö LIFF URLs
                </button>
            </div>
            <div class="col-md-6 mb-2">
                <button type="button" class="btn btn-success w-100" onclick="generateLiffTestUrl()">
                    <i class="fas fa-external-link-alt me-2"></i>‡∏™‡∏£‡πâ‡∏≤‡∏á Test URL
                </button>
            </div>
        </div>
        
        <div class="card bg-light mb-3">
            <div class="card-body p-3">
                <h6 class="card-title mb-2">‚ö° Quick LIFF ID Setup</h6>
                <div class="row">
                    <div class="col-md-6 mb-2">
                        <label for="quick-liff-form" class="form-label small">LIFF_ID_FORM:</label>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" id="quick-liff-form" placeholder="xxxxxxxxxx-xxxxxxxx">
                            <button class="btn btn-outline-primary" type="button" onclick="updateEnvironmentVariable('LIFF_ID_FORM')">
                                <i class="fas fa-save"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <label for="quick-liff-tech" class="form-label small">LIFF_ID_TECHNICIAN_LOCATION:</label>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" id="quick-liff-tech" placeholder="xxxxxxxxxx-xxxxxxxx">
                            <button class="btn btn-outline-primary" type="button" onclick="updateEnvironmentVariable('LIFF_ID_TECHNICIAN_LOCATION')">
                                <i class="fas fa-save"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <small class="text-muted">üí° ‡∏õ‡πâ‡∏≠‡∏ô LIFF ID ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏Å‡∏î Save ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Environment Variables</small>
            </div>
        </div>
        
        <div id="liffDebugResult" class="mt-3"></div>
    </div>
</div>

<form method="POST" action="{{ url_for('settings_page') }}" id="form_shop_tech_info">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-store me-2"></i>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏≤‡∏á</h5>
        </div>
        <div class="card-body p-4">
            <div class="row mb-3">
                <label for="shop_contact_phone" class="col-md-4 col-form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</label>
                <div class="col-md-8">
                    <input type="text" class="form-control" id="shop_contact_phone" name="shop_info[contact_phone]"
                           value="{{ settings.shop_info.contact_phone }}">
                </div>
            </div>
            <div class="row mb-3">
                <label for="shop_line_id" class="col-md-4 col-form-label">LINE ID ‡∏£‡πâ‡∏≤‡∏ô</label>
                <div class="col-md-8">
                    <input type="text" class="form-control" id="shop_line_id" name="shop_info[line_id]"
                           value="{{ settings.shop_info.line_id }}">
                </div>
            </div>
            <hr>
            <h6 class="mt-3">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á</h6>
            <div id="technician-management-list-container" class="list-group technician-management-list mb-3">
                </div>
            <button type="button" class="btn btn-success" onclick="openTechnicianEditModal()">
                <i class="fas fa-plus me-2"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
            </button>
        </div>
        <div class="card-footer text-end">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏≤‡∏á
            </button>
        </div>
    </div>
</form>

<div class="card shadow-sm mb-4">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0"><i class="fas fa-qrcode me-2"></i>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (QR Code)</h5>
    </div>
    <div class="card-body p-4 text-center">
        <p class="text-muted">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û QR Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (‡πÄ‡∏ä‡πà‡∏ô PromptPay) ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏ô‡∏µ‡πâ</p>
        
        <div class="mb-3">
            {% set qr_code_id = settings.shop_info.get('payment_qr_code_id') %}
            <img id="qr-code-preview" 
                 src="{% if qr_code_id %}https://drive.google.com/thumbnail?id={{ qr_code_id }}&sz=w200{% else %}https://via.placeholder.com/200x200.png?text=Upload+QR+Code{% endif %}" 
                 class="img-thumbnail" 
                 alt="QR Code Preview" 
                 style="max-width: 200px; height: auto;">
        </div>
        
        <div class="mb-3">
            <input class="form-control" type="file" id="qr-code-upload-input" accept="image/*">
        </div>
        
        <button type="button" class="btn btn-success" id="save-qr-code-btn" disabled>
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
            <i class="fas fa-save me-2"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å QR Code
        </button>
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-header bg-warning text-dark">
        <h5 class="mb-0"><i class="fas fa-robot me-2"></i>ü§ñ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ LINE Bot</h5>
    </div>
    <div class="card-body p-4">
        <div class="alert alert-info">
            <strong>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á LINE Bot:</strong> ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ LINE Bot ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        </div>
        
        <div class="d-flex flex-wrap gap-2 mb-3">
            <button type="button" class="btn btn-info" onclick="checkLineBotStatus()">
                <i class="fas fa-search me-2"></i>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ LINE Bot
            </button>
        </div>
        
        <div id="lineBotStatusResult" class="mt-3"></div>
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-header bg-secondary text-white">
        <h5 class="mb-0"><i class="fas fa-tools me-2"></i>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin Tools)</h5>
    </div>
    <div class="card-body p-4">
<h6 class="mb-3">‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h6>
        <div class="d-flex flex-wrap gap-2 mb-3">
            <a href="{{ url_for('backup_data') }}" class="btn btn-primary"><i class="fas fa-download me-2"></i>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Backup ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</a>
            <form action="{{ url_for('trigger_auto_backup_now') }}" method="POST" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <button type="submit" class="btn btn-info" onclick="return confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏õ‡∏ó‡∏µ‡πà Google Drive ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')"><i class="fab fa-google-drive me-2"></i>‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Backup ‡πÑ‡∏õ‡∏ó‡∏µ‡πà Drive</button>
            </form>
        </div>

        <div class="card mt-3">
             <div class="card-body bg-light">
                <h6 class="card-title">‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏£‡∏≠‡∏á (Restore)</h6>
                 <div class="alert alert-danger small p-2">
                     <strong>‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</strong> ‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏ä‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∞‡∏°‡∏±‡∏î‡∏£‡∏∞‡∏ß‡∏±‡∏á
                 </div>
                 <div class="mb-2">
                     <label for="backup_file_input" class="form-label small">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á (.json):</label>
                     <input class="form-control form-control-sm" type="file" id="backup_file_input" accept=".json">
                 </div>
                 <div class="mb-2">
                     <label for="backup_type_select" class="form-label small">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</label>
                     <select class="form-select form-select-sm" id="backup_type_select">
                         <option value="tasks_json">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô (Tasks)</option>
                         <option value="settings_json">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (Settings)</option>
                     </select>
                 </div>
                 <button type="button" class="btn btn-sm btn-primary" id="preview_backup_btn"><i class="fas fa-eye me-1"></i>‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
                 <div id="backup_preview_area" class="mt-3" style="display:none;">
                     <div id="preview_content" class="p-2 bg-white border rounded small"></div>
                     <button type="button" class="btn btn-sm btn-danger mt-2" id="import_backup_btn"><i class="fas fa-exclamation-triangle me-1"></i>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô</button>
                 </div>
                 <div id="import_status" class="mt-2 small"></div>
             </div>
        </div>
        <hr>

<div class="card mb-4" id="data-management">
    <div class="card-header">
        <h4><i class="fas fa-database me-2"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Data Management)</h4>
    </div>
    <div class="card-body">
        <p>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ</p>
        <div class="d-flex flex-wrap gap-2">
            <a href="{{ url_for('manage_duplicates') }}" class="btn btn-outline-warning"><i class="fas fa-copy me-2"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô</a>
            <a href="{{ url_for('manage_equipment_duplicates') }}" class="btn btn-outline-warning"><i class="fas fa-boxes me-2"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô</a>
            <a href="{{ url_for('manage_job_item_duplicates') }}" class="btn btn-outline-warning"><i class="fas fa-receipt me-2"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡πÉ‡∏ö‡∏á‡∏≤‡∏ô</a>
            
            <a href="{{ url_for('liff.manage_customer_duplicates') }}" class="btn btn-outline-warning"><i class="fas fa-users me-2"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô</a>
            <a href="{{ url_for('organize_files') }}" class="btn btn-outline-info"><i class="fas fa-folder-open me-2"></i>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏à‡∏±‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÑ‡∏ü‡∏•‡πå</a>
            <form action="{{ url_for('cleanup_drive_folders') }}" method="POST" onsubmit="return confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏ß‡∏°‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡πÉ‡∏ô Google Drive ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <button type="submit" class="btn btn-outline-info">
                    <i class="fas fa-broom me-2"></i>‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ã‡πâ‡∏≥
                </button>
            </form>

            <form action="{{ url_for('recalculate_all_stock') }}" method="post" onsubmit="return confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');" class="d-inline">
                 <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                 <button type="submit" class="btn btn-danger">
                     <i class="fas fa-calculator me-2"></i> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                 </button>
            </form>
        </div>
    </div>
</div>
<div class="card mb-4">
    <div class="card-header">
         <h4><i class="fas fa-heartbeat me-2"></i> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Health Check & Repair)</h4>
    </div>
    <div class="card-body">
        <p class="small text-muted">
            ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏™‡πÅ‡∏Å‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô (‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÉ‡∏ô Drive ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥) ‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏≥‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        </p>
        <button class="btn btn-primary" id="scan-health-btn">
            <i class="fas fa-search-plus me-2"></i>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        </button>
        <div id="health-check-results" class="mt-3" style="display:none;">
            <p id="scan-summary"></p>
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead>
                        <tr>
                            <th>‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô / ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                            <th class="text-center">‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏´‡∏≤‡∏¢</th>
                            <th class="text-center">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="issues-table-body">
                        </tbody>
                </table>
            </div>
        </div>
        <div id="scan-spinner" class="text-center mt-3" style="display:none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•, ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</p>
        </div>
    </div>
</div>
			
<div class="modal fade" id="testNotificationModal" tabindex="-1" aria-labelledby="testNotificationModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="testNotificationModalLabel">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° LINE</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="{{ url_for('test_notification') }}" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="modal-body">
            <div class="mb-3">
              <label for="test_recipient" class="form-label">ID ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö (User ID / Group ID):</label>
              <input type="text" class="form-control" id="test_recipient" name="test_recipient" value="{{ settings.line_recipients.admin_group_id }}" required>
            </div>
            <div class="mb-3">
              <label for="test_type" class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</label>
              <select class="form-select" id="test_type" name="test_type">
                  <option value="simple_text">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤</option>
                  <option value="customer_completion">‡πÅ‡∏à‡πâ‡∏á‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)</option>
                  <option value="customer_follow_up">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏• (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤)</option>
                  <option value="admin_new_task">‡πÅ‡∏à‡πâ‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="test_message" class="form-label">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó '‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤'):</label>
              <textarea class="form-control" name="test_message" id="test_message" rows="3">[‡∏ó‡∏î‡∏™‡∏≠‡∏ö] ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</textarea>
            </div>
            <small class="form-text text-muted">‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà "‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤" ‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</small>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
          <button type="submit" class="btn btn-primary">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="technicianEditModal" tabindex="-1" aria-labelledby="technicianEditModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="technicianEditModalLabel">‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏≤‡∏á</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="technician-name" class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á</label>
                    <input type="text" class="form-control" id="technician-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ä‡πà‡∏≤‡∏á‡πÇ‡∏ï‡πâ" required>
                </div>
                <div class="mb-3">
                    <label for="technician-line-id" class="form-label">LINE User ID</label>
                    <input type="text" class="form-control" id="technician-line-id" placeholder="LINE User ID ‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á">
                    <div class="form-text">‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (‡πÄ‡∏ä‡πà‡∏ô ‡∏á‡∏≤‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á)</div>
                </div>
                <div class="mb-3">
                    <label for="technician-lat" class="form-label">‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î (Latitude)</label>
                    <input type="number" step="any" class="form-control" id="technician-lat" placeholder="‡πÄ‡∏ä‡πà‡∏ô 13.xxxxxx">
                    <div class="form-text">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏á‡∏≤‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á)</div>
                </div>
                <div class="mb-3">
                    <label for="technician-lon" class="form-label">‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î (Longitude)</label>
                    <input type="number" step="any" class="form-control" id="technician-lon" placeholder="‡πÄ‡∏ä‡πà‡∏ô 100.xxxxxx">
                </div>
                <div class="mb-3">
                    <label for="technician-avatar-file" class="form-label">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå (Avatar)</label>
                    <input type="file" class="form-control" id="technician-avatar-file" accept="image/*">
                    <div class="form-text">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏¥‡∏°)</div>
                    <input type="hidden" id="technician-avatar-id">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button type="button" class="btn btn-primary" id="save-technician-btn" onclick="saveTechnician()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block body_extra %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- START: ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö User Management ---
    const userModal = new bootstrap.Modal(document.getElementById('userModal'));
    
    async function fetchAndRenderUsers() {
        const response = await fetch('/api/users');
        const users = await response.json();
        const userListBody = document.getElementById('user-list-body');
        userListBody.innerHTML = '';
        users.forEach(user => {
            const row = `
                <tr>
                    <td>${user.username}</td>
                    <td><span class="badge bg-${user.role === 'admin' ? 'success' : 'secondary'}">${user.role}</span></td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary edit-user-btn" data-id="${user.id}" data-username="${user.username}" data-role="${user.role}"><i class="fas fa-pen"></i></button>
                        <button class="btn btn-sm btn-outline-danger delete-user-btn" data-id="${user.id}"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `;
            userListBody.insertAdjacentHTML('beforeend', row);
        });
    }

    document.getElementById('add-user-btn').addEventListener('click', () => {
        document.getElementById('userModalLabel').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà';
        document.getElementById('user-id').value = '';
        document.getElementById('user-username').value = '';
        document.getElementById('user-password').value = '';
        document.getElementById('user-password').required = true;
        document.getElementById('password-required-star').style.display = 'inline';
        document.getElementById('password-help').textContent = '‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô';
        document.getElementById('user-role').value = 'user';
        userModal.show();
    });

    document.getElementById('user-list-body').addEventListener('click', e => {
        if (e.target.closest('.edit-user-btn')) {
            const btn = e.target.closest('.edit-user-btn');
            document.getElementById('userModalLabel').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
            document.getElementById('user-id').value = btn.dataset.id;
            document.getElementById('user-username').value = btn.dataset.username;
            document.getElementById('user-password').value = '';
            document.getElementById('user-password').required = false;
            document.getElementById('password-required-star').style.display = 'none';
            document.getElementById('password-help').textContent = '‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á)';
            document.getElementById('user-role').value = btn.dataset.role;
            userModal.show();
        }
        if (e.target.closest('.delete-user-btn')) {
            const btn = e.target.closest('.delete-user-btn');
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?')) {
                fetch(`/api/users/${btn.dataset.id}`, { 
                    method: 'DELETE',
                    headers: { 'X-CSRFToken': "{{ csrf_token() }}" }
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        flashMessage(data.message, 'success');
                        fetchAndRenderUsers();
                    } else { throw new Error(data.message); }
                })
                .catch(err => flashMessage(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}`, 'danger'));
            }
        }
    });

    document.getElementById('save-user-btn').addEventListener('click', () => {
        const payload = {
            id: document.getElementById('user-id').value || null,
            username: document.getElementById('user-username').value,
            password: document.getElementById('user-password').value,
            role: document.getElementById('user-role').value,
        };
        fetch('/api/users', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': "{{ csrf_token() }}" },
            body: JSON.stringify(payload)
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                flashMessage(data.message, 'success');
                userModal.hide();
                fetchAndRenderUsers();
            } else { throw new Error(data.message); }
        })
        .catch(err => flashMessage(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}`, 'danger'));
    });
    
    fetchAndRenderUsers(); // Initial load
    // --- END: ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö User Management ---


    let technicianTemplates = {
        task_details: {{ settings.technician_templates.task_details | tojson | safe }},
        progress_reports: {{ settings.technician_templates.progress_reports | tojson | safe }}
    };

    function renderTemplates(category) {
        const container = document.getElementById(`${category.replace('_', '-')}-templates-container`);
        if (!container) return;
        container.innerHTML = '';
        technicianTemplates[category].forEach((template, index) => {
            const templateEl = document.createElement('div');
            templateEl.className = 'template-item';
            templateEl.innerHTML = `
                <input type="text" class="form-control form-control-sm" placeholder="‡∏Ñ‡∏≥‡∏¢‡πà‡∏≠ (Key)" value="${template.key}" data-index="${index}" data-category="${category}" onchange="updateTemplate(this)">
                <input type="text" class="form-control" placeholder="‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ï‡πá‡∏° (Value)" value="${template.value}" data-index="${index}" data-category="${category}" onchange="updateTemplate(this)">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeTemplate('${category}', ${index})"><i class="fas fa-trash"></i></button>
            `;
            container.appendChild(templateEl);
        });
    }

    window.addTemplate = (category) => {
        technicianTemplates[category].push({ key: '', value: '' });
        renderTemplates(category);
    };

    window.removeTemplate = (category, index) => {
        if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏•‡∏ï‡∏ô‡∏µ‡πâ?')) {
            technicianTemplates[category].splice(index, 1);
            renderTemplates(category);
        }
    };
    
    window.updateTemplate = (inputElement) => {
        const category = inputElement.dataset.category;
        const index = parseInt(inputElement.dataset.index);
        const property = inputElement.placeholder.includes('Key') ? 'key' : 'value';
        technicianTemplates[category][index][property] = inputElement.value;
    };

    let technicians = {{ settings.technician_list | tojson | safe }};
    let technicianEditModal = new bootstrap.Modal(document.getElementById('technicianEditModal'));
    let currentIndex = -1;
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;

	function renderTechnicianList() {
        const container = document.getElementById('technician-management-list-container');
        if (!container) return;
        container.innerHTML = '';
        if (technicians.length === 0) {
            container.innerHTML = '<p class="text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>';
        } else {
            technicians.forEach((tech, index) => {
                // --- START: ‚úÖ ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---
                // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ via.placeholder.com ‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡πÅ‡∏ó‡∏ô
                const initial = tech.name && tech.name.trim() !== '' ? tech.name.trim().charAt(0).toUpperCase() : '?';
                const avatarUrl = tech.avatar_id ? `https://drive.google.com/thumbnail?id=${tech.avatar_id}&sz=s40-c` : `/static/logo.png`;
                // --- END: ‚úÖ ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ---

                const item = document.createElement('div');
                item.className = 'list-group-item';
                item.innerHTML = `
                    <img src="${avatarUrl}" class="technician-avatar" alt="${tech.name}">
                    <span class="technician-name">${tech.name}</span>
                    <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="openTechnicianEditModal(${index})"><i class="fas fa-edit"></i></button>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteTechnician(${index})"><i class="fas fa-trash"></i></button>
                `;
                container.appendChild(item);
            });
        }
    }

    window.openTechnicianEditModal = (index = -1) => {
        currentIndex = index;
        document.getElementById('technician-avatar-file').value = '';
        if (index > -1) {
            const tech = technicians[index];
            document.getElementById('technician-name').value = tech.name;
            document.getElementById('technician-avatar-id').value = tech.avatar_id || '';
            document.getElementById('technician-line-id').value = tech.line_user_id || '';
            document.getElementById('technician-lat').value = tech.last_known_lat || '';
            document.getElementById('technician-lon').value = tech.last_known_lon || '';
            document.getElementById('technicianEditModalLabel').innerText = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡πà‡∏≤‡∏á';
        } else {
            document.getElementById('technician-name').value = '';
            document.getElementById('technician-avatar-id').value = '';
            document.getElementById('technician-line-id').value = '';
            document.getElementById('technician-lat').value = '';
            document.getElementById('technician-lon').value = '';
            document.getElementById('technicianEditModalLabel').innerText = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà';
        }
        technicianEditModal.show();
    }

    window.saveTechnician = async () => {
        const saveBtn = document.getElementById('save-technician-btn');
        const originalBtnText = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

        const name = document.getElementById('technician-name').value.trim();
        const avatarFile = document.getElementById('technician-avatar-file').files[0];
        let avatarId = document.getElementById('technician-avatar-id').value;
        const lineUserId = document.getElementById('technician-line-id').value.trim();
        const lat = document.getElementById('technician-lat').value;
        const lon = document.getElementById('technician-lon').value;

        if (!name) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á');
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalBtnText;
            return;
        }

        if (avatarFile) {
            const formData = new FormData();
            formData.append('file', avatarFile);
            try {
                const response = await fetch('/api/upload_avatar', {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': csrfToken }
                });
                const result = await response.json();
                if (result.status === 'success') {
                    avatarId = result.file_id;
                    flashMessage('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                } else { throw new Error(result.message); }
            } catch (error) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û: ' + error.message);
                saveBtn.disabled = false; saveBtn.innerHTML = originalBtnText; return;
            }
        }

        const newTech = {
            name: name, avatar_id: avatarId, line_user_id: lineUserId,
            last_known_lat: lat !== '' ? parseFloat(lat) : null,
            last_known_lon: lon !== '' ? parseFloat(lon) : null
        };

        if (currentIndex > -1) technicians[currentIndex] = newTech;
        else technicians.push(newTech);

        renderTechnicianList();
        technicianEditModal.hide();
        saveBtn.disabled = false; saveBtn.innerHTML = originalBtnText;
    }

    window.deleteTechnician = (index) => {
        if (confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ä‡πà‡∏≤‡∏á "${technicians[index].name}"?`)) {
            technicians.splice(index, 1);
            renderTechnicianList();
        }
    }

    async function handleFormSubmit(event, formId) {
        event.preventDefault();
        const form = document.getElementById(formId);
        const submitButton = form.querySelector('button[type="submit"]');
        const originalBtnText = submitButton.innerHTML;

        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

        let data = {};

        if (formId === 'form_technician_templates') {
             data = {
                technician_templates: technicianTemplates,
                csrf_token: form.querySelector('input[name="csrf_token"]').value
            };
        } else {
            const formData = new FormData(form);
            form.querySelectorAll('input[type=checkbox]').forEach(checkbox => {
                const parts = checkbox.name.match(/^(.*)\[(.*)\]$/);
                if (parts) {
                    const parent = parts[1];
                    const child = parts[2];
                    if (!data[parent]) data[parent] = {};
                    data[parent][child] = checkbox.checked;
                }
            });

            formData.forEach((value, key) => {
                const parts = key.match(/^(.*)\[(.*)\]$/);
                if (parts) {
                    const parent = parts[1];
                    const child = parts[2];
                    if (!data[parent]) data[parent] = {};
                    const inputElement = form.querySelector(`[name="${key}"]`);
                    if (inputElement && inputElement.type === 'checkbox') {
                         if (!data[parent].hasOwnProperty(child)) {
                             data[parent][child] = value;
                         }
                    } else {
                        data[parent][child] = value;
                    }
                } else {
                    data[key] = value;
                }
            });

            if (formId === 'form_shop_tech_info') {
                data['technician_list'] = technicians;
            }
        }
        
        try {
            const response = await fetch(form.action, {
                method: 'POST',
                body: JSON.stringify(data),
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            });

            const result = await response.json();
            if (response.ok && result.status === 'success') {
                flashMessage(result.message, 'success');
            } else {
                flashMessage(result.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏', 'danger');
            }
        } catch (error) {
            flashMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message, 'danger');
        } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = originalBtnText;
        }
    }

    document.getElementById('form_technician_templates').addEventListener('submit', (e) => handleFormSubmit(e, 'form_technician_templates'));
    document.getElementById('form_report_settings').addEventListener('submit', (e) => handleFormSubmit(e, 'form_report_settings'));
    document.getElementById('form_message_templates').addEventListener('submit', (e) => handleFormSubmit(e, 'form_message_templates'));
    document.getElementById('form_liff_notifications').addEventListener('submit', (e) => handleFormSubmit(e, 'form_liff_notifications'));
    document.getElementById('form_line_bot_info').addEventListener('submit', (e) => handleFormSubmit(e, 'form_line_bot_info'));
    document.getElementById('form_shop_tech_info').addEventListener('submit', (e) => handleFormSubmit(e, 'form_shop_tech_info'));

    renderTechnicianList();
    renderTemplates('task_details');
    renderTemplates('progress_reports');

    const backupFileInput = document.getElementById('backup_file_input');
    const backupTypeSelect = document.getElementById('backup_type_select');
    const previewBtn = document.getElementById('preview_backup_btn');
    const importBtn = document.getElementById('import_backup_btn');
    const previewArea = document.getElementById('backup_preview_area');
    const previewContent = document.getElementById('preview_content');
    const importStatus = document.getElementById('import_status');

    if (previewBtn) {
        previewBtn.addEventListener('click', async () => {
            const file = backupFileInput.files[0];
            if (!file) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); return; }
            const formData = new FormData();
            formData.append('backup_file', file);
            formData.append('file_type', backupTypeSelect.value);
            formData.append('csrf_token', csrfToken);
            importStatus.innerHTML = '<span class="text-primary">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå...</span>';
            previewArea.style.display = 'none';
            try {
                const response = await fetch("{{ url_for('preview_backup_file') }}", { method: 'POST', body: formData });
                const result = await response.json();
                if (response.ok && result.status === 'success') {
                    let previewHtml = '';
                    if (result.type === 'tasks') {
                        previewHtml = `<p><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</strong> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô</p><p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:</strong> ${result.task_count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p><h6>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å:</h6><ul>`;
                        result.example_tasks.forEach(t => { previewHtml += `<li>${t.title} (‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${t.customer_name})</li>`; });
                        previewHtml += '</ul>';
                    } else if (result.type === 'settings') {
                        previewHtml = `<p><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</strong> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</p>
                                        <p><strong>Admin Group ID:</strong> ${result.preview_settings.admin_group_id}</p>
                                        <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡πà‡∏≤‡∏á:</strong> ${result.preview_settings.technician_list_count} ‡∏Ñ‡∏ô</p>`;
                    }
                    previewContent.innerHTML = previewHtml;
                    previewArea.style.display = 'block';
                    importStatus.innerHTML = '';
                } else { throw new Error(result.message); }
            } catch (error) { importStatus.innerHTML = `<span class="text-danger">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</span>`; }
        });
    }

    if (importBtn) {
        importBtn.addEventListener('click', async () => {
            if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö!')) { return; }
            const file = backupFileInput.files[0];
            if (!file) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'); return; }
            const formData = new FormData();
            formData.append('backup_file', file);
            formData.append('file_type', backupTypeSelect.value);
            formData.append('csrf_token', csrfToken);
            importStatus.innerHTML = '<span class="text-primary">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•... ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</span>';
            importBtn.disabled = true;
            try {
                const response = await fetch("{{ url_for('api_import_backup_file') }}", { method: 'POST', body: formData });
                const result = await response.json();
                if (response.ok && result.status === 'success') {
                    importStatus.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
                    alert('‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏à‡∏∞‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î');
                    window.location.reload();
                } else { throw new Error(result.message); }
            } catch (error) {
                importStatus.innerHTML = `<div class="alert alert-danger">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</div>`;
                importBtn.disabled = false;
            }
        });
    }

    const qrCodeInput = document.getElementById('qr-code-upload-input');
    const qrCodePreview = document.getElementById('qr-code-preview');
    const saveQrCodeBtn = document.getElementById('save-qr-code-btn');
    let uploadedFileId = null;

    if(qrCodeInput) {
        qrCodeInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    qrCodePreview.src = e.target.result;
                }
                reader.readAsDataURL(file);
                saveQrCodeBtn.disabled = false;
            }
        });
    }

    if(saveQrCodeBtn) {
        saveQrCodeBtn.addEventListener('click', async function() {
            const file = qrCodeInput.files[0];
            if (!file) {
                flashMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û QR Code ‡∏Å‡πà‡∏≠‡∏ô', 'warning');
                return;
            }

            const spinner = saveQrCodeBtn.querySelector('.spinner-border');
            const icon = saveQrCodeBtn.querySelector('.fa-save');
            spinner.style.display = 'inline-block';
            icon.style.display = 'none';
            saveQrCodeBtn.disabled = true;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const uploadResponse = await fetch('/api/upload_payment_qr', {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': csrfToken }
                });
                const uploadResult = await uploadResponse.json();
                if (!uploadResponse.ok) throw new Error(uploadResult.message);
                
                uploadedFileId = uploadResult.file_id;

                const settingsResponse = await fetch("{{ url_for('settings_page') }}", {
                    method: 'POST',
                    body: JSON.stringify({
                        shop_info: { payment_qr_code_id: uploadedFileId }
                    }),
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                });
                const settingsResult = await settingsResponse.json();
                if (!settingsResponse.ok) throw new Error(settingsResult.message);

                flashMessage('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å QR Code ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                qrCodeInput.value = '';

            } catch (error) {
                flashMessage(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'danger');
            } finally {
                spinner.style.display = 'none';
                icon.style.display = 'inline-block';
                saveQrCodeBtn.disabled = true;
            }
        });
    }
	// --- START: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç JavaScript ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Warehouse Management ---
	const warehouseModalEl = document.getElementById('warehouseModal');
	const warehouseModal = new bootstrap.Modal(warehouseModalEl);

	document.getElementById('warehouse-type').addEventListener('change', function() {
		const techGroup = document.getElementById('technician-name-group');
		techGroup.style.display = this.value === 'technician_van' ? 'block' : 'none';
	});

	document.getElementById('add-warehouse-btn').addEventListener('click', () => {
		document.getElementById('warehouseModalLabel').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà';
		document.getElementById('warehouse-id').value = '';
		document.getElementById('warehouse-name').value = '';
		document.getElementById('warehouse-type').value = 'main';
		// Clear selections in multi-select
		Array.from(document.getElementById('warehouse-tech-name').options).forEach(opt => opt.selected = false);
		document.getElementById('technician-name-group').style.display = 'none';
		warehouseModal.show();
	});

	document.getElementById('warehouse-list-body').addEventListener('click', (e) => {
		const editBtn = e.target.closest('.edit-warehouse-btn');
		if (editBtn) {
			const row = editBtn.closest('tr');
			document.getElementById('warehouseModalLabel').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
			document.getElementById('warehouse-id').value = row.dataset.id;
			document.getElementById('warehouse-name').value = row.dataset.name;
			document.getElementById('warehouse-type').value = row.dataset.type;
			
			// Handle multi-select population
			const techSelect = document.getElementById('warehouse-tech-name');
			const associatedTechs = (row.dataset.tech || '').split(',');
			Array.from(techSelect.options).forEach(option => {
				option.selected = associatedTechs.includes(option.value);
			});

			document.getElementById('technician-name-group').style.display = row.dataset.type === 'technician_van' ? 'block' : 'none';
			warehouseModal.show();
		}
		
		// Delete button logic remains the same
		const deleteBtn = e.target.closest('.delete-warehouse-btn');
		if (deleteBtn) {
			const row = deleteBtn.closest('tr');
			if (confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ñ‡∏•‡∏±‡∏á "${row.dataset.name}"?`)) {
				fetch(`/api/warehouses/${row.dataset.id}/delete`, { 
					method: 'DELETE',
					headers: { 'X-CSRFToken': "{{ csrf_token() }}" }
				})
				.then(res => res.json())
				.then(data => {
					if (data.status === 'success') {
						flashMessage(data.message, 'success');
						row.remove();
					} else {
						throw new Error(data.message);
					}
				})
				.catch(err => flashMessage(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}`, 'danger'));
			}
		}
	});

document.getElementById('save-warehouse-btn').addEventListener('click', () => {
    const id = document.getElementById('warehouse-id').value;
    const name = document.getElementById('warehouse-name').value;
    const type = document.getElementById('warehouse-type').value;
    
    // Get all selected technicians from multi-select
    const techSelect = document.getElementById('warehouse-tech-name');
    const techNames = Array.from(techSelect.selectedOptions).map(opt => opt.value);

    if (!name.trim()) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
        return;
    }

    fetch('/api/warehouses/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': "{{ csrf_token() }}" },
        body: JSON.stringify({ id: id, name: name, type: type, technician_names: techNames }) // Send as 'technician_names'
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {
            flashMessage(data.message, 'success');
            warehouseModal.hide();
            setTimeout(() => window.location.reload(), 1000);
        } else {
            throw new Error(data.message);
        }
    })
    .catch(err => flashMessage(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${err.message}`, 'danger'));
});
// --- END: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç JavaScript ---
    
    // --- START: Health Check JS ---
    const scanBtn = document.getElementById('scan-health-btn');
    const scanSpinner = document.getElementById('scan-spinner');
    const resultsContainer = document.getElementById('health-check-results');
    const scanSummary = document.getElementById('scan-summary');
    const issuesTableBody = document.getElementById('issues-table-body');

    scanBtn.addEventListener('click', async () => {
        scanBtn.disabled = true;
        scanSpinner.style.display = 'block';
        resultsContainer.style.display = 'none';
        issuesTableBody.innerHTML = '';

        try {
            const response = await fetch("{{ url_for('health_check_scan') }}");
            const data = await response.json();

            if (data.status === 'success') {
                scanSummary.textContent = `‡∏û‡∏ö ${data.issues.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤:`;
                if (data.issues.length === 0) {
                     scanSummary.innerHTML = '<span class="text-success fw-bold">‚úÖ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</span>';
                } else {
                    data.issues.forEach(issue => {
                        const row = document.createElement('tr');
                        row.id = `issue-row-${issue.job_id}`;
                        row.innerHTML = `
                            <td>
                                <strong>${issue.job_title}</strong><br>
                                <small class="text-muted">${issue.customer_name}</small>
                            </td>
                            <td class="text-center align-middle"><span class="badge bg-danger">${issue.missing_count}</span></td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-success repair-btn" data-job-id="${issue.job_id}">
                                    <i class="fas fa-tools me-1"></i> ‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°
                                </button>
                            </td>
                        `;
                        issuesTableBody.appendChild(row);
                    });
                }
                resultsContainer.style.display = 'block';
            } else {
                throw new Error(data.message);
            }
        } catch (error) {
            flashMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πÅ‡∏Å‡∏ô: ' + error.message, 'danger');
        } finally {
            scanBtn.disabled = false;
            scanSpinner.style.display = 'none';
        }
    });

    issuesTableBody.addEventListener('click', async (event) => {
        const repairButton = event.target.closest('.repair-btn');
        if (repairButton) {
            const button = repairButton;
            const job_id = button.dataset.jobId;
            
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

            try {
                const response = await fetch(`/api/health_check/repair/${job_id}`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': "{{ csrf_token() }}" }
                });
                const result = await response.json();
                if (response.ok && result.status === 'success') {
                     const row = document.getElementById(`issue-row-${job_id}`);
                     row.innerHTML = `<td colspan="3" class="text-success text-center p-2">${result.message}</td>`;
                     setTimeout(() => {
                         row.style.opacity = '0';
                         row.style.transition = 'opacity 0.5s ease';
                         setTimeout(() => row.remove(), 500);
                     }, 2000);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                flashMessage(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°: ${error.message}`, 'danger');
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-tools me-1"></i> ‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°';
            }
        }
    });
    // --- END: Health Check JS ---
});

function flashMessage(message, category) {
    const mainContainer = document.getElementById('flash-messages-area'); // <--- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
    if (!mainContainer) return;
    const newMessage = document.createElement('div');
    newMessage.className = `alert alert-${category} alert-dismissible fade show`;
    newMessage.setAttribute('role', 'alert');
    newMessage.innerHTML = `${message} <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
    mainContainer.prepend(newMessage);
    setTimeout(() => {
        const alertInstance = bootstrap.Alert.getInstance(newMessage);
        if (alertInstance) alertInstance.close();
        else newMessage.remove();
    }, 5000);
}
</script>
{% endblock %}