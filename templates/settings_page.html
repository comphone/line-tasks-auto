{% extends "base.html" %}

{% block title %}ตั้งค่าระบบ{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
    <h2 class="mb-4"><i class="fas fa-cogs me-2"></i>ตั้งค่าระบบ</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message | safe }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab" aria-controls="general" aria-selected="true"><i class="fas fa-store me-2"></i>ทั่วไป & LINE</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="technicians-tab" data-bs-toggle="tab" data-bs-target="#technicians" type="button" role="tab" aria-controls="technicians" aria-selected="false"><i class="fas fa-hard-hat me-2"></i>ช่าง & เทมเพลต</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="warehouse-tab" data-bs-toggle="tab" data-bs-target="#warehouse" type="button" role="tab" aria-controls="warehouse" aria-selected="false"><i class="fas fa-warehouse me-2"></i>คลังสินค้า</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab" aria-controls="users" aria-selected="false"><i class="fas fa-users-cog me-2"></i>ผู้ใช้งาน</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="data-management-tab" data-bs-toggle="tab" data-bs-target="#data-management" type="button" role="tab" aria-controls="data-management" aria-selected="false"><i class="fas fa-database me-2"></i>จัดการข้อมูล</button>
        </li>
    </ul>

    <div class="tab-content" id="settingsTabsContent">
        <div class="tab-pane fade show active" id="general" role="tabpanel" aria-labelledby="general-tab">
            <form id="settings-form-general">
                <div class="card mt-3">
                    <div class="card-body">
                        <div class="mb-4">
                            <h5><i class="fas fa-store me-2"></i>ข้อมูลร้าน/บริษัท</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="shop_name" class="form-label">ชื่อร้าน/บริษัท</label>
                                    <input type="text" class="form-control" id="shop_name" value="{{ settings.shop_info.name }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="shop_phone" class="form-label">เบอร์โทรติดต่อ</label>
                                    <input type="text" class="form-control" id="shop_phone" value="{{ settings.shop_info.contact_phone }}">
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label for="shop_address" class="form-label">ที่อยู่</label>
                                    <textarea class="form-control" id="shop_address" rows="2">{{ settings.shop_info.address }}</textarea>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="mb-4">
                            <h5><i class="fab fa-line me-2"></i>ตั้งค่าการแจ้งเตือน LINE</h5>
                             <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="admin_group_id" class="form-label">Admin Group ID</label>
                                    <input type="text" class="form-control" id="admin_group_id" value="{{ settings.line_recipients.admin_group_id }}">
                                    <small class="form-text text-muted">สำหรับรับการแจ้งเตือนสำคัญทั้งหมด</small>
                                </div>
                                 <div class="col-md-6 mb-3">
                                    <label for="technician_group_id" class="form-label">Technician Group ID</label>
                                    <input type="text" class="form-control" id="technician_group_id" value="{{ settings.line_recipients.technician_group_id }}">
                                     <small class="form-text text-muted">สำหรับแจ้งเตือนงานประจำวันให้ช่าง</small>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="mb-4">
                             <h5><i class="fas fa-cloud-upload-alt me-2"></i>สำรองข้อมูลอัตโนมัติ (Google Drive)</h5>
                             <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="auto_backup_enabled" {% if settings.auto_backup.enabled %}checked{% endif %}>
                                <label class="form-check-label" for="auto_backup_enabled">เปิดใช้งานการสำรองข้อมูลอัตโนมัติ</label>
                            </div>
                             <div class="row">
                                 <div class="col-md-6">
                                     <label for="auto_backup_hour" class="form-label">เวลา (ชั่วโมง)</label>
                                    <input type="number" class="form-control" id="auto_backup_hour" min="0" max="23" value="{{ settings.auto_backup.hour_thai }}">
                                 </div>
                                 <div class="col-md-6">
                                    <label for="auto_backup_minute" class="form-label">นาที</label>
                                    <input type="number" class="form-control" id="auto_backup_minute" min="0" max="59" value="{{ settings.auto_backup.minute_thai }}">
                                 </div>
                             </div>
                        </div>
                        <div class="text-end">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-save me-2"></i>บันทึกการตั้งค่าทั่วไป</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div class="tab-pane fade" id="technicians" role="tabpanel" aria-labelledby="technicians-tab">
             <form id="settings-form-technicians">
                <div class="card mt-3">
                    <div class="card-body">
                        <div class="mb-4">
                            <h5><i class="fas fa-hard-hat me-2"></i>จัดการรายชื่อช่าง</h5>
                            <div id="technician-list-container">
                                </div>
                            <button type="button" class="btn btn-outline-success mt-2" id="add-technician-btn"><i class="fas fa-plus me-2"></i>เพิ่มช่าง</button>
                        </div>
                        <hr>
                        <div class="mb-4">
                            <h5><i class="fas fa-comment-alt me-2"></i>เทมเพลตข้อความอัตโนมัติ</h5>
                            <div class="mb-3">
                                <label for="template-daily-reminder" class="form-label">ข้อความแจ้งเตือนงานประจำวัน</label>
                                <textarea class="form-control" id="template-daily-reminder" rows="5">{{ settings.message_templates.daily_reminder_task_line }}</textarea>
                            </div>
                            <div class="mb-3">
                                <label for="template-problem-report" class="form-label">ข้อความแจ้งเตือนเมื่อลูกค้าแจ้งปัญหา</label>
                                <textarea class="form-control" id="template-problem-report" rows="5">{{ settings.message_templates.problem_report_admin }}</textarea>
                            </div>
                        </div>
                        <div class="text-end">
                            <button type="submit" class="btn btn-primary"><i class="fas fa-save me-2"></i>บันทึกข้อมูลช่างและเทมเพลต</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div class="tab-pane fade" id="warehouse" role="tabpanel" aria-labelledby="warehouse-tab">
             <div class="card mt-3">
                <div class="card-body">
                    <h5><i class="fas fa-warehouse me-2"></i>จัดการคลังสินค้า</h5>
                    <div id="warehouse-list">
                        {% for wh in warehouses %}
                        <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                            <span>
                                <i class="fas fa-{{ 'truck' if wh.type == 'technician_van' else 'warehouse' }} me-2"></i>
                                <strong>{{ wh.name }}</strong> ({{ wh.type }})
                                {% if wh.technician_name %}
                                <small class="text-muted">- {{ wh.technician_name }}</small>
                                {% endif %}
                            </span>
                            <div>
                                <button class="btn btn-sm btn-outline-primary edit-warehouse-btn" data-id="{{ wh.id }}" data-name="{{ wh.name }}" data-type="{{ wh.type }}" data-techs="{{ wh.technician_name or '' }}">แก้ไข</button>
                                <button class="btn btn-sm btn-outline-danger delete-warehouse-btn" data-id="{{ wh.id }}">ลบ</button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <button class="btn btn-success mt-3" id="add-warehouse-btn"><i class="fas fa-plus me-2"></i>เพิ่มคลังสินค้าใหม่</button>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="users" role="tabpanel" aria-labelledby="users-tab">
            <div class="card mt-3">
                <div class="card-body">
                    <h5><i class="fas fa-users-cog me-2"></i>จัดการผู้ใช้งาน</h5>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>ชื่อผู้ใช้</th>
                                    <th>สิทธิ์</th>
                                    <th>จัดการ</th>
                                </tr>
                            </thead>
                            <tbody id="user-list-tbody">
                                </tbody>
                        </table>
                    </div>
                     <button class="btn btn-success mt-3" id="add-user-btn"><i class="fas fa-user-plus me-2"></i>เพิ่มผู้ใช้งานใหม่</button>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="data-management" role="tabpanel" aria-labelledby="data-management-tab">
            
            <div class="card mt-3">
                <div class="card-header bg-primary text-white">
                    <h4><i class="fas fa-magic me-2"></i> เครื่องมือแก้ไขอัตโนมัติ (แนะนำ)</h4>
                </div>
                <div class="card-body">
                    <p class="text-muted">หากปุ่ม "เลือกเก็บไว้ 1 รายการ" ในหน้าจัดการข้อมูลซ้ำด้านล่างไม่ทำงาน ให้ใช้เครื่องมืออัตโนมัตินี้แทน</p>
                    <div class="alert alert-info">
                        <h5 class="alert-heading"><i class="fas fa-broom me-2"></i> ล้างข้อมูลค่าใช้จ่ายซ้ำอัตโนมัติ</h5>
                        <p>เครื่องมือนี้จะทำการค้นหาค่าใช้จ่ายที่ซ้ำกันในทุกใบงาน จากนั้นจะ **เก็บรายการที่เก่าที่สุดไว้ 1 รายการ** และลบรายการที่ซ้ำกันที่เหลือทั้งหมดออกไปจากระบบให้โดยอัตโนมัติ</p>
                        <hr>
                        <form action="{{ url_for('cleanup_job_item_duplicates_auto') }}" method="post" onsubmit="return confirm('คุณแน่ใจหรือไม่? ระบบจะลบรายการค่าใช้จ่ายที่ซ้ำซ้อนทั้งหมด (ยกเว้นรายการแรก) ออกอย่างถาวร');" class="d-inline">
                             <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                             <button type="submit" class="btn btn-primary fw-bold">
                                 <i class="fas fa-play-circle me-2"></i> เริ่มการล้างข้อมูลอัตโนมัติ
                             </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                 <div class="card-header">
                    <h4><i class="fas fa-database me-2"></i> จัดการข้อมูลด้วยตนเอง</h4>
                </div>
                <div class="card-body">
                    <p>เครื่องมือสำหรับจัดการข้อมูลจำนวนมากด้วยตนเอง</p>
                    <div class="d-flex flex-wrap gap-2">
                        <a href="{{ url_for('manage_duplicates') }}" class="btn btn-outline-warning"><i class="fas fa-copy me-2"></i>จัดการงานที่ซ้ำซ้อน</a>
                        <a href="{{ url_for('manage_equipment_duplicates') }}" class="btn btn-outline-warning"><i class="fas fa-boxes me-2"></i>จัดการอุปกรณ์ที่ซ้ำกัน</a>
                        <a href="{{ url_for('manage_job_item_duplicates') }}" class="btn btn-outline-warning"><i class="fas fa-receipt me-2"></i>จัดการค่าใช้จ่ายที่ซ้ำในใบงาน</a>
                        <a href="{{ url_for('liff.manage_customer_duplicates') }}" class="btn btn-outline-warning"><i class="fas fa-users me-2"></i>จัดการลูกค้าที่ซ้ำกัน</a>
                        <a href="{{ url_for('organize_files') }}" class="btn btn-outline-info"><i class="fas fa-folder-open me-2"></i>เครื่องมือจัดระเบียบไฟล์</a>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                     <h4><i class="fas fa-heartbeat me-2"></i> ตรวจสอบและซ่อมแซมข้อมูล</h4>
                </div>
                <div class="card-body">
                    <p class="small text-muted">
                        เครื่องมือนี้จะสแกนหารายการงานที่อาจมีข้อมูลรูปภาพไม่ตรงกัน (มีรูปใน Drive แต่ไม่มีในประวัติ)
                    </p>
                    <button class="btn btn-primary" id="scan-health-btn">
                        <i class="fas fa-search-plus me-2"></i>ตรวจสอบความสมบูรณ์ของข้อมูล
                    </button>
                    <div id="health-check-results" class="mt-3" style="display:none;">
                        <p id="scan-summary"></p>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>ชื่องาน / ลูกค้า</th>
                                        <th class="text-center">รูปที่หาย</th>
                                        <th class="text-center">จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="issues-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="scan-spinner" class="text-center mt-3" style="display:none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">กำลังสแกนข้อมูล, กรุณารอสักครู่...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="user-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="user-modal-title"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="user-form">
                    <input type="hidden" id="user-id">
                    <div class="mb-3">
                        <label for="username" class="form-label">ชื่อผู้ใช้</label>
                        <input type="text" class="form-control" id="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">รหัสผ่าน</label>
                        <input type="password" class="form-control" id="password">
                        <small class="form-text text-muted" id="password-help"></small>
                    </div>
                    <div class="mb-3">
                         <label for="role" class="form-label">สิทธิ์</label>
                         <select id="role" class="form-select">
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                         </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                <button type="button" class="btn btn-primary" id="save-user-btn">บันทึก</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="warehouse-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="warehouse-modal-title"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="warehouse-form">
                     <input type="hidden" id="warehouse-id">
                     <div class="mb-3">
                        <label for="warehouse-name" class="form-label">ชื่อคลังสินค้า</label>
                        <input type="text" id="warehouse-name" class="form-control" required>
                     </div>
                     <div class="mb-3">
                        <label for="warehouse-type" class="form-label">ประเภท</label>
                        <select id="warehouse-type" class="form-select">
                            <option value="main">คลังหลัก (Main)</option>
                            <option value="technician_van">คลังบนรถ (Technician Van)</option>
                        </select>
                     </div>
                     <div class="mb-3" id="technician-names-container" style="display: none;">
                        <label class="form-label">ผูกกับช่าง</label>
                         <div id="technician-checkboxes">
                             </div>
                     </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                <button type="button" class="btn btn-primary" id="save-warehouse-btn">บันทึก</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = '{{ csrf_token() }}';

    // Function to show a toast notification
    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toast-container');
        if (!toastContainer) return;
        const toastId = 'toast-' + Date.now();
        const toastHtml = `
            <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
        toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
    }

    // General Settings Form
    const generalForm = document.getElementById('settings-form-general');
    if(generalForm) {
        generalForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const data = {
                shop_info: {
                    name: document.getElementById('shop_name').value,
                    contact_phone: document.getElementById('shop_phone').value,
                    address: document.getElementById('shop_address').value,
                },
                line_recipients: {
                    admin_group_id: document.getElementById('admin_group_id').value,
                    technician_group_id: document.getElementById('technician_group_id').value,
                },
                auto_backup: {
                    enabled: document.getElementById('auto_backup_enabled').checked,
                    hour_thai: parseInt(document.getElementById('auto_backup_hour').value),
                    minute_thai: parseInt(document.getElementById('auto_backup_minute').value)
                }
            };
            saveSettings(data, 'บันทึกการตั้งค่าทั่วไปเรียบร้อยแล้ว');
        });
    }

    // Technicians & Templates Form
    const techForm = document.getElementById('settings-form-technicians');
    if(techForm){
        techForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const technician_list = [];
            document.querySelectorAll('.technician-item').forEach(item => {
                technician_list.push({
                    name: item.querySelector('input[id^="tech-name"]').value,
                    line_user_id: item.querySelector('input[id^="tech-line-id"]').value,
                    avatar_file_id: item.querySelector('input[id^="tech-avatar-id"]').value
                });
            });
            const data = {
                technician_list: technician_list,
                message_templates: {
                    daily_reminder_task_line: document.getElementById('template-daily-reminder').value,
                    problem_report_admin: document.getElementById('template-problem-report').value,
                }
            };
            saveSettings(data, 'บันทึกข้อมูลช่างและเทมเพลตเรียบร้อยแล้ว');
        });
    }

    // Generic Save Settings Function
    function saveSettings(data, successMessage) {
        fetch('{{ url_for("settings_page") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                showToast(successMessage);
            } else {
                showToast(result.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('เกิดข้อผิดพลาดในการเชื่อมต่อ', 'danger');
        });
    }

    // Technician List Management
    const techContainer = document.getElementById('technician-list-container');
    const allTechnicians = {{ settings.technician_list|tojson }};
    
    function renderTechnicians() {
        if(!techContainer) return;
        techContainer.innerHTML = '';
        allTechnicians.forEach((tech, index) => {
            const techItem = document.createElement('div');
            techItem.className = 'technician-item border p-3 mb-2 rounded';
            techItem.innerHTML = `
                <div class="row align-items-center">
                    <div class="col-auto">
                        <img src="${tech.avatar_file_id ? '/api/proxy_drive_image/' + tech.avatar_file_id : 'https://via.placeholder.com/60'}" class="rounded-circle" width="60" height="60" alt="Avatar" id="avatar-preview-${index}">
                    </div>
                    <div class="col">
                        <input type="text" class="form-control mb-1" id="tech-name-${index}" placeholder="ชื่อช่าง" value="${tech.name || ''}">
                        <input type="text" class="form-control" id="tech-line-id-${index}" placeholder="LINE User ID" value="${tech.line_user_id || ''}">
                        <input type="hidden" id="tech-avatar-id-${index}" value="${tech.avatar_file_id || ''}">
                    </div>
                    <div class="col-auto">
                        <input type="file" id="avatar-upload-${index}" class="d-none" accept="image/*">
                        <button type="button" class="btn btn-sm btn-outline-secondary upload-avatar-btn" data-index="${index}">เปลี่ยนรูป</button>
                        <button type="button" class="btn btn-sm btn-outline-danger remove-technician-btn" data-index="${index}">ลบ</button>
                    </div>
                </div>
            `;
            techContainer.appendChild(techItem);
        });
    }

    if(techContainer) {
        renderTechnicians();

        document.getElementById('add-technician-btn').addEventListener('click', () => {
            allTechnicians.push({ name: '', line_user_id: '', avatar_file_id: '' });
            renderTechnicians();
        });

        techContainer.addEventListener('click', e => {
            if (e.target.classList.contains('remove-technician-btn')) {
                const index = e.target.dataset.index;
                allTechnicians.splice(index, 1);
                renderTechnicians();
            }
            if (e.target.classList.contains('upload-avatar-btn')) {
                const index = e.target.dataset.index;
                document.getElementById(`avatar-upload-${index}`).click();
            }
        });

        techContainer.addEventListener('change', e => {
            if (e.target.id.startsWith('avatar-upload-')) {
                const index = e.target.id.split('-')[2];
                const file = e.target.files[0];
                if (file) {
                    const formData = new FormData();
                    formData.append('file', file);
                    fetch('/api/upload_avatar', { method: 'POST', headers: { 'X-CSRFToken': csrfToken }, body: formData })
                    .then(res => res.json())
                    .then(data => {
                        if(data.status === 'success') {
                            document.getElementById(`tech-avatar-id-${index}`).value = data.file_id;
                            document.getElementById(`avatar-preview-${index}`).src = `/api/proxy_drive_image/${data.file_id}`;
                            showToast('อัปโหลดรูปสำเร็จ');
                        } else {
                            showToast(data.message, 'danger');
                        }
                    });
                }
            }
        });
    }


    // Health Check & Repair
    const scanBtn = document.getElementById('scan-health-btn');
    const resultsDiv = document.getElementById('health-check-results');
    const spinner = document.getElementById('scan-spinner');
    const summaryP = document.getElementById('scan-summary');
    const issuesTbody = document.getElementById('issues-table-body');
    
    if (scanBtn) {
        scanBtn.addEventListener('click', () => {
            spinner.style.display = 'block';
            resultsDiv.style.display = 'none';
            scanBtn.disabled = true;

            fetch('/api/health_check/scan')
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    summaryP.textContent = `พบ ${data.issues.length} งานที่มีปัญหา`;
                    issuesTbody.innerHTML = '';
                    if (data.issues.length > 0) {
                        data.issues.forEach(issue => {
                            const row = `
                                <tr>
                                    <td>
                                        <strong>${issue.job_title}</strong><br>
                                        <small class="text-muted">${issue.customer_name}</small>
                                    </td>
                                    <td class="text-center">${issue.missing_count}</td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-success repair-btn" data-job-id="${issue.job_id}">ซ่อมแซม</button>
                                    </td>
                                </tr>`;
                            issuesTbody.insertAdjacentHTML('beforeend', row);
                        });
                    } else {
                         issuesTbody.innerHTML = '<tr><td colspan="3" class="text-center text-success">ไม่พบข้อมูลที่มีปัญหา</td></tr>';
                    }
                    resultsDiv.style.display = 'block';
                } else {
                    summaryP.textContent = `เกิดข้อผิดพลาด: ${data.message}`;
                    resultsDiv.style.display = 'block';
                }
            })
            .catch(err => {
                summaryP.textContent = 'เกิดข้อผิดพลาดในการเชื่อมต่อกับเซิร์ฟเวอร์';
                resultsDiv.style.display = 'block';
            })
            .finally(() => {
                spinner.style.display = 'none';
                scanBtn.disabled = false;
            });
        });

        issuesTbody.addEventListener('click', (e) => {
            if (e.target.classList.contains('repair-btn')) {
                const btn = e.target;
                const jobId = btn.dataset.jobId;
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

                fetch(`/api/health_check/repair/${jobId}`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken }
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        showToast(data.message);
                        btn.closest('tr').remove();
                    } else {
                        showToast(data.message, 'danger');
                        btn.disabled = false;
                        btn.textContent = 'ซ่อมแซม';
                    }
                });
            }
        });
    }

    // User Management
    const userModal = new bootstrap.Modal(document.getElementById('user-modal'));
    const userListTbody = document.getElementById('user-list-tbody');

    function loadUsers() {
        if(!userListTbody) return;
        fetch('/api/users')
            .then(res => res.json())
            .then(users => {
                userListTbody.innerHTML = '';
                users.forEach(user => {
                    userListTbody.innerHTML += `
                        <tr>
                            <td>${user.username}</td>
                            <td><span class="badge bg-${user.role === 'admin' ? 'success' : 'secondary'}">${user.role}</span></td>
                            <td>
                                <button class="btn btn-sm btn-primary edit-user-btn" data-id="${user.id}" data-username="${user.username}" data-role="${user.role}">แก้ไข</button>
                                <button class="btn btn-sm btn-danger delete-user-btn" data-id="${user.id}">ลบ</button>
                            </td>
                        </tr>`;
                });
            });
    }

    if(userListTbody) {
        loadUsers();

        document.getElementById('add-user-btn').addEventListener('click', () => {
            document.getElementById('user-form').reset();
            document.getElementById('user-id').value = '';
            document.getElementById('user-modal-title').textContent = 'เพิ่มผู้ใช้ใหม่';
            document.getElementById('password').required = true;
            document.getElementById('password-help').textContent = 'ต้องระบุรหัสผ่านสำหรับผู้ใช้ใหม่';
            userModal.show();
        });

        userListTbody.addEventListener('click', e => {
            if (e.target.classList.contains('edit-user-btn')) {
                const btn = e.target;
                document.getElementById('user-form').reset();
                document.getElementById('user-id').value = btn.dataset.id;
                document.getElementById('username').value = btn.dataset.username;
                document.getElementById('role').value = btn.dataset.role;
                document.getElementById('password').required = false;
                document.getElementById('password-help').textContent = 'เว้นว่างไว้หากไม่ต้องการเปลี่ยนรหัสผ่าน';
                document.getElementById('user-modal-title').textContent = 'แก้ไขผู้ใช้';
                userModal.show();
            } else if (e.target.classList.contains('delete-user-btn')) {
                if (confirm('คุณแน่ใจหรือไม่ว่าต้องการลบผู้ใช้นี้?')) {
                    fetch(`/api/users/${e.target.dataset.id}`, { method: 'DELETE', headers: {'X-CSRFToken': csrfToken} })
                        .then(res => res.json())
                        .then(data => {
                            showToast(data.message, data.status);
                            if (data.status === 'success') loadUsers();
                        });
                }
            }
        });

        document.getElementById('save-user-btn').addEventListener('click', () => {
             fetch('/api/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({
                    id: document.getElementById('user-id').value,
                    username: document.getElementById('username').value,
                    password: document.getElementById('password').value,
                    role: document.getElementById('role').value
                })
            })
            .then(res => res.json())
            .then(data => {
                showToast(data.message, data.status);
                if (data.status === 'success') {
                    userModal.hide();
                    loadUsers();
                }
            });
        });
    }
    
    // Warehouse Management
    const warehouseModal = new bootstrap.Modal(document.getElementById('warehouse-modal'));
    const technicianNamesContainer = document.getElementById('technician-names-container');
    const warehouseTypeSelect = document.getElementById('warehouse-type');

    if(warehouseTypeSelect) {
        warehouseTypeSelect.addEventListener('change', function() {
            technicianNamesContainer.style.display = this.value === 'technician_van' ? 'block' : 'none';
        });

        document.getElementById('add-warehouse-btn').addEventListener('click', () => {
            document.getElementById('warehouse-form').reset();
            document.getElementById('warehouse-id').value = '';
            document.getElementById('warehouse-modal-title').textContent = 'เพิ่มคลังสินค้าใหม่';
            warehouseTypeSelect.dispatchEvent(new Event('change'));
            warehouseModal.show();
        });

        document.getElementById('warehouse-list').addEventListener('click', e => {
            if (e.target.classList.contains('edit-warehouse-btn')) {
                const btn = e.target;
                document.getElementById('warehouse-form').reset();
                document.getElementById('warehouse-id').value = btn.dataset.id;
                document.getElementById('warehouse-name').value = btn.dataset.name;
                document.getElementById('warehouse-type').value = btn.dataset.type;
                const techs = btn.dataset.techs.split(',');
                document.querySelectorAll('#technician-checkboxes input').forEach(cb => {
                    cb.checked = techs.includes(cb.value);
                });
                warehouseTypeSelect.dispatchEvent(new Event('change'));
                document.getElementById('warehouse-modal-title').textContent = 'แก้ไขคลังสินค้า';
                warehouseModal.show();
            } else if (e.target.classList.contains('delete-warehouse-btn')) {
                if(confirm('คุณแน่ใจหรือไม่ว่าต้องการลบคลังสินค้านี้? (จะลบได้ก็ต่อเมื่อไม่มีสต็อกคงเหลือ)')) {
                    fetch(`/api/warehouses/${e.target.dataset.id}/delete`, { method: 'DELETE', headers: { 'X-CSRFToken': csrfToken } })
                    .then(res => res.json()).then(data => {
                         showToast(data.message, data.status);
                         if (data.status === 'success') window.location.reload();
                    });
                }
            }
        });

        document.getElementById('save-warehouse-btn').addEventListener('click', () => {
            const selectedTechs = Array.from(document.querySelectorAll('#technician-checkboxes input:checked')).map(cb => cb.value);
            fetch('/api/warehouses/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({
                    id: document.getElementById('warehouse-id').value,
                    name: document.getElementById('warehouse-name').value,
                    type: document.getElementById('warehouse-type').value,
                    technician_names: selectedTechs
                })
            })
            .then(res => res.json()).then(data => {
                showToast(data.message, data.status);
                if (data.status === 'success') window.location.reload();
            });
        });
        
        // Populate technician checkboxes
        const techCheckboxesDiv = document.getElementById('technician-checkboxes');
        if(techCheckboxesDiv) {
            techCheckboxesDiv.innerHTML = '';
            allTechnicians.forEach(tech => {
                if(tech.name) {
                    techCheckboxesDiv.innerHTML += `
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" value="${tech.name}" id="tech-check-${tech.name}">
                          <label class="form-check-label" for="tech-check-${tech.name}">${tech.name}</label>
                        </div>
                    `;
                }
            });
        }
    }
});
</script>
{% endblock %}