<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { background-color: #f0f2f5; }
        .card { border: none; border-radius: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .card-header { background-color: #00B900; color: white; border-top-left-radius: 1rem; border-top-right-radius: 1rem; }
        .loader { border: 5px solid #f3f3f3; border-radius: 50%; border-top: 5px solid #3498db; width: 50px; height: 50px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .action-btn { text-decoration: none; display: block; }
    </style>
</head>
<body>
    <div class="container p-3">
        <div id="loading-spinner" class="d-flex justify-content-center align-items-center" style="height: 80vh;">
            <div class="loader"></div>
        </div>

        <div id="content" class="d-none">
            <div class="card">
                <div class="card-header text-center">
                    <h5 class="mb-0" id="notification-title"></h5>
                </div>
                <div class="card-body p-4">
                    <div class="mb-3">
                        <small class="text-muted">‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô</small>
                        <h6 id="task-title" class="fw-bold"></h6>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</small>
                        <h6 id="customer-name"></h6>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted">‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</small>
                        <h6 id="due-date"></h6>
                    </div>
                    <hr>
                    <div class="d-grid gap-2">
                        <a id="btn-details" href="#" class="btn btn-primary action-btn"><i class="fas fa-file-alt me-2"></i> ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô‡πÄ‡∏ï‡πá‡∏°</a>
                        <a id="btn-call" href="#" class="btn btn-success action-btn"><i class="fas fa-phone me-2"></i> ‡πÇ‡∏ó‡∏£‡∏´‡∏≤‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</a>
                        <a id="btn-map" href="#" target="_blank" class="btn btn-info action-btn"><i class="fas fa-map-marked-alt me-2"></i> ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡∏ó‡∏≤‡∏á</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
        async function initializeLiff() {
            try {
                // ‚≠ê ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà ‚≠ê
                const liffId = "{{ LIFF_ID_FORM }}";
                console.log("üîç Debug LIFF Info:");
                console.log("- LIFF ID from server:", liffId);
                console.log("- LIFF ID length:", liffId ? liffId.length : 0);
                console.log("- LIFF ID type:", typeof liffId);
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ LIFF ID ‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if (!liffId || liffId.trim() === '' || liffId === 'None' || liffId === 'undefined') {
                    throw new Error(`LIFF ID ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: "${liffId}". ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Environment Variables`);
                }
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö LIFF ID (‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô nnnnnnnnnn-xxxxxxxx)
                const liffIdPattern = /^\d{10}-[a-zA-Z0-9]{8}$/;
                if (!liffIdPattern.test(liffId)) {
                    throw new Error(`‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö LIFF ID ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: "${liffId}". ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô nnnnnnnnnn-xxxxxxxx`);
                }
                
                console.log("‚úÖ LIFF ID validation passed");
                console.log("üöÄ Initializing LIFF...");
                
                await liff.init({ liffId: liffId });
                console.log("‚úÖ LIFF initialized successfully");
                
                if (!liff.isLoggedIn()) {
                    console.log("‚ùå User not logged in, redirecting to login...");
                    liff.login();
                } else {
                    console.log("‚úÖ User already logged in");
                    fetchData();
                }
                // ‚≠ê ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡πÇ‡∏Ñ‡πâ‡∏î‡πÉ‡∏´‡∏°‡πà ‚≠ê
            } catch (error) {
                console.error("‚ùå LIFF initialization failed:", error);
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏∂‡πâ‡∏ô
                let errorMessage = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î LIFF App:\n\n";
                errorMessage += `üî¥ ${error.message}\n\n`;
                errorMessage += "üîß ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:\n";
                errorMessage += "1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö LIFF ID ‡πÉ‡∏ô Environment Variables\n";
                errorMessage += "2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö LIFF App ‡πÉ‡∏ô LINE Developers Console\n";
                errorMessage += "3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Endpoint URL ‡πÉ‡∏ô LIFF App Settings";
                
                alert(errorMessage);
                
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• debug ‡πÉ‡∏ô console
                console.log("üîç Debug: Fetching server debug info...");
                fetch('/debug/liff')
                    .then(response => response.json())
                    .then(data => {
                        console.log("üîç Server LIFF Debug Info:", data);
                    })
                    .catch(debugError => {
                        console.error("‚ùå Failed to fetch debug info:", debugError);
                    });
            }
        }

        function fetchData() {
            const urlParams = new URLSearchParams(window.location.search);
            const taskId = urlParams.get('task_id');
            const notiType = urlParams.get('type');

            if (!taskId) {
                document.getElementById('loading-spinner').innerHTML = '<p class="text-danger">‡πÑ‡∏°‡πà‡∏û‡∏ö Task ID</p>';
                return;
            }

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà
            fetch(`/api/task_summary/${taskId}`)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    populateData(data, notiType);
                    document.getElementById('loading-spinner').classList.add('d-none');
                    document.getElementById('content').classList.remove('d-none');
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    document.getElementById('loading-spinner').innerHTML = '<p class="text-danger">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ</p>';
                });
        }

        function populateData(data, notiType) {
            const titleMap = {
                'new_task': "‚ú® ‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤!",
                'arrival': "üîî ‡∏ä‡πà‡∏≤‡∏á‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏ñ‡∏∂‡∏á!",
                'completion': "‚úÖ ‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!",
                'nearby_job': "üìç ‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á!",
                'update': "üóìÔ∏è ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏á‡∏≤‡∏ô!"
            };
            document.getElementById('notification-title').innerText = titleMap[notiType] || '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô';
            document.getElementById('task-title').innerText = data.title || '-';
            document.getElementById('customer-name').innerText = data.customer.name || '-';
            document.getElementById('due-date').innerText = data.due_formatted || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≥‡∏´‡∏ô‡∏î';

            document.getElementById('btn-details').href = data.task_details_url || '#';
            document.getElementById('btn-call').href = data.customer.phone ? `tel:${data.customer.phone}` : '#';
            document.getElementById('btn-map').href = data.customer.map_url || '#';

            if (!data.customer.phone) document.getElementById('btn-call').classList.add('disabled');
            if (!data.customer.map_url) document.getElementById('btn-map').classList.add('disabled');
        }

        window.onload = initializeLiff;
    </script>
</body>
</html>